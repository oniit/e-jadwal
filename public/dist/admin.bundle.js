const b=window.location.origin;async function re(){try{const e=await fetch(`${b}/auth/me`,{credentials:"include"});if(!e.ok){window.location.href="/login";return}const t=await e.json();if(oe(t.username),window.__adminUserRole=t.role,t.role==="superadmin"){const n=document.getElementById("admin-tab-users");n&&n.classList.remove("hidden")}if(t.role==="supir"){const n=document.querySelector(".flex.space-x-1.p-1.rounded-xl.bg-gray-100");n&&n.classList.add("hidden"),document.querySelectorAll('[id^="admin-content-"]').forEach(o=>{o.classList.add("hidden")});const s=document.getElementById("admin-content-kendaraan");s&&s.classList.remove("hidden");const r=document.getElementById("filters-kendaraan");r&&r.classList.add("hidden")}t.role==="admin"&&t.adminType==="khusus"&&(["admin-tab-kendaraan","admin-tab-driver","admin-tab-master","admin-tab-users"].forEach(s=>{const r=document.getElementById(s);r&&r.classList.add("hidden")}),t.managedAssetCodes&&Array.isArray(t.managedAssetCodes)&&(window.__adminKhususGedungOnly=t.managedAssetCodes.filter(s=>s.startsWith("GD"))))}catch(e){console.error("Auth check failed:",e),window.location.href="/login"}}function oe(e){const t=document.getElementById("admin-username");t&&(t.textContent=e)}function ie(){const e=document.getElementById("btn-logout");e&&e.addEventListener("click",async()=>{try{await fetch(`${b}/auth/logout`,{method:"POST",credentials:"include"}),window.location.href="/"}catch(t){console.error("Logout failed:",t),alert("Logout gagal")}})}function de(){const e=document.getElementById("btn-profile"),t=document.getElementById("modal-profile");e&&t&&e.addEventListener("click",async()=>{try{const n=await fetch(`${b}/auth/me`,{credentials:"include"});if(!n.ok){const a=await n.json().catch(()=>({}));throw new Error(a.message||`HTTP ${n.status}`)}const s=await n.json(),r=s.user||s;document.getElementById("profile-username").value=r.username||"",document.getElementById("profile-name").value=r.name||"",document.getElementById("profile-email").value=r.email||"",document.getElementById("profile-phone").value=r.phone||"";const o=document.getElementById("profile-status-wrapper");o&&o.classList.add("hidden"),t.classList.remove("hidden")}catch(n){console.error("Load profile failed:",n),alert("Gagal memuat profil: "+n.message)}}),document.querySelectorAll(".modal-close-btn").forEach(n=>{n.addEventListener("click",s=>{s.target.closest(".modal-backdrop").classList.add("hidden")})}),document.querySelectorAll(".modal-backdrop").forEach(n=>{n.addEventListener("click",s=>{s.target===n&&n.classList.add("hidden")})})}function le(){const e=document.getElementById("form-profile");e&&e.addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("profile-name").value,s=document.getElementById("profile-email").value,r=document.getElementById("profile-phone").value,o=document.getElementById("profile-current-password").value,a=document.getElementById("profile-new-password").value,c=document.getElementById("profile-status");try{const d={name:n,email:s,phone:r};c&&!document.getElementById("profile-status-wrapper").classList.contains("hidden")&&(d.isActive=c.value==="true"),a&&o&&(d.currentPassword=o,d.newPassword=a);const l=await fetch(`${b}/auth/profile`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(d)});if(l.ok)alert("Profil berhasil diperbarui"),document.getElementById("profile-current-password").value="",document.getElementById("profile-new-password").value="",document.getElementById("modal-profile").classList.add("hidden");else{const u=await l.json();alert(u.message||"Gagal memperbarui profil")}}catch(d){console.error("Update profile failed:",d),alert("Terjadi kesalahan saat memperbarui profil")}}),ce()}function ce(){const e=document.getElementById("form-user");if(!e)return;const t=document.getElementById("btn-add-user");t&&t.addEventListener("click",()=>{e.reset(),document.getElementById("user-id").value="",document.getElementById("generated-password-display").classList.add("hidden"),document.getElementById("user-form-title").textContent="Tambah Admin",document.getElementById("user-admin-umum").checked=!0,document.getElementById("user-managed-assets-wrapper").classList.add("hidden");const n=document.getElementById("user-status-wrapper");n&&n.classList.add("hidden"),document.getElementById("modal-user-form").classList.remove("hidden")}),e.addEventListener("submit",async n=>{n.preventDefault();const s=document.getElementById("user-id").value,r={username:document.getElementById("user-username").value.trim(),name:document.getElementById("user-name").value.trim(),email:document.getElementById("user-email").value.trim(),phone:document.getElementById("user-phone").value.trim(),adminType:document.querySelector('input[name="user-admin-type"]:checked')?.value||"umum",managedAssetCodes:[]},o=document.getElementById("user-status-wrapper"),a=document.getElementById("user-status");if(s&&o&&!o.classList.contains("hidden")&&a&&(r.isActive=a.value==="true"),r.adminType==="khusus"){const c=document.querySelectorAll('input[name="managed-asset"]:checked');r.managedAssetCodes=Array.from(c).map(d=>d.value)}if(!r.username||!r.name||!r.email){alert("Username, name, dan email wajib diisi");return}try{const c=s?"PUT":"POST",d=s?`${b}/auth/admin/${s}`:`${b}/auth/admin`,l=await fetch(d,{method:c,headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(r)});if(!l.ok){const i=await l.json();throw new Error(i.message||"Gagal menyimpan admin")}const u=await l.json();!s&&u.generatedPassword?(document.getElementById("generated-password-text").textContent=u.generatedPassword,document.getElementById("generated-password-display").classList.remove("hidden"),document.getElementById("copy-password-btn").addEventListener("click",()=>{navigator.clipboard.writeText(u.generatedPassword),alert("Password berhasil disalin")})):(alert(`Admin berhasil ${s?"diperbarui":"dibuat"}`),document.getElementById("modal-user-form").classList.add("hidden"),R())}catch(c){alert(`Gagal: ${c.message}`)}})}async function R(){try{const n=(await(await fetch(`${b}/auth/admins`,{credentials:"include"})).json()).admins||[],s=document.getElementById("users-list-table");if(!s)return;s.innerHTML="";const r=[...n].sort((o,a)=>(o.username||"").localeCompare(a.username||""));if(r.length===0){s.innerHTML='<tr><td colspan="6" class="px-6 py-3 text-center text-gray-500">Tidak ada data</td></tr>';return}s.innerHTML=r.map(o=>{const a="px-6 py-3 whitespace-nowrap text-sm text-gray-500",c=o.isActive?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600",d=o.isActive?"Aktif":"Tidak Aktif";return`<tr class="cursor-pointer" data-admin-id="${o._id}">
                <td class="${a}">${o.username||"-"}</td>
                <td class="${a}">${o.name||"-"}</td>
                <td class="${a}">${o.email||"-"}</td>
                <td class="${a}">${o.phone||"-"}</td>
                <td class="${a}">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${c}">${d}</span>
                </td>
                <td class="px-6 py-3 text-right text-sm">
                    <div class="flex justify-end gap-3">
                        <button class="btn-edit" data-id="${o._id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${o._id}" title="Hapus"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`}).join("")}catch(e){console.error("Gagal memuat admin:",e)}}function ue(){const e=document.getElementById("users-list-table");e&&e.addEventListener("click",async t=>{const n=t.target.closest(".btn-edit"),s=t.target.closest(".btn-delete");if(t.target.closest("tr[data-admin-id]")){if(n){const o=n.dataset.id;try{const c=await(await fetch(`${b}/auth/admin/${o}`,{credentials:"include"})).json(),d=c.admin||c;document.getElementById("user-id").value=d._id,document.getElementById("user-username").value=d.username,document.getElementById("user-name").value=d.name,document.getElementById("user-email").value=d.email,document.getElementById("user-phone").value=d.phone||"";const l=d.adminType||"umum";document.getElementById("user-admin-umum").checked=l==="umum",document.getElementById("user-admin-khusus").checked=l==="khusus";const u=document.getElementById("user-status-wrapper"),i=document.getElementById("user-status");if(u&&i&&(u.classList.remove("hidden"),i.value=d.isActive?"true":"false"),l==="khusus"){document.getElementById("user-managed-assets-wrapper").classList.remove("hidden");const f=(await(await fetch(`${b}/api/assets`,{credentials:"include"})).json()).gedung||[],p=document.getElementById("user-managed-assets");p&&(p.innerHTML=f.map(y=>{const I=(d.managedAssetCodes||[]).includes(y.code);return`
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" value="${y.code}" name="managed-asset" ${I?"checked":""}>
                                    <span>${y.code} - ${y.name}</span>
                                </label>
                            `}).join(""))}else document.getElementById("user-managed-assets-wrapper").classList.add("hidden");document.getElementById("user-form-title").textContent="Edit Admin",document.getElementById("generated-password-display").classList.add("hidden"),document.getElementById("modal-user-form").classList.remove("hidden")}catch(a){alert("Gagal memuat data admin: "+a.message)}}else if(s){const o=s.dataset.id;if(confirm("Hapus admin ini?"))try{const a=await fetch(`${b}/auth/admin/${o}`,{method:"DELETE",credentials:"include"});if(a.ok)alert("Admin berhasil dihapus"),R();else{const c=await a.json();alert("Gagal menghapus: "+(c.message||"Error"))}}catch(a){alert("Gagal menghapus admin: "+a.message)}}}})}function me(){const e=document.querySelectorAll('input[name="user-admin-type"]'),t=document.getElementById("user-managed-assets-wrapper");e.forEach(n=>{n.addEventListener("change",async s=>{if(s.target.value==="khusus"){t?.classList.remove("hidden");try{const a=(await(await fetch(`${b}/api/assets`,{credentials:"include"})).json()).gedung||[],c=document.getElementById("user-managed-assets");c&&a&&a.length>0&&(c.innerHTML=a.map(d=>`
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" value="${d.code}" name="managed-asset">
                                <span>${d.code} - ${d.name}</span>
                            </label>
                        `).join(""))}catch(r){console.error("Gagal memuat aset:",r)}}else t?.classList.add("hidden")})})}function ge(){fetch(`${b}/auth/me`,{credentials:"include"}).then(e=>e.json()).then(e=>{e.role==="superadmin"&&(R(),ue())}).catch(e=>console.error("Error loading admin data:",e))}function pe(){const e=document.querySelectorAll(".tab-btn"),t=window.__adminUserRole;if(e.forEach(n=>{n.addEventListener("click",s=>{if(t==="supir"){s.preventDefault();return}const r=n.id.replace("admin-tab-","");e.forEach(a=>a.classList.remove("active")),n.classList.add("active"),document.querySelectorAll('[id^="admin-content-"]').forEach(a=>{a.classList.add("hidden")});const o=document.getElementById(`admin-content-${r}`);o&&o.classList.remove("hidden")})}),t==="supir"){document.querySelectorAll('[id^="admin-content-"]').forEach(s=>{s.classList.add("hidden")});const n=document.getElementById("admin-content-kendaraan");n&&n.classList.remove("hidden")}else{const n=document.getElementById("admin-tab-request");n&&!n.classList.contains("hidden")&&n.click()}}function D(e){try{const t=new Date(e);return isNaN(t.getTime())?"":t.toISOString().split("T")[0]}catch(t){return console.error("Error formatting date:",e,t),""}}function B(){return window.__adminState||null}function A(e){if(Array.isArray(e))return e;if(e&&Array.isArray(e.data))return e.data;if(e&&Array.isArray(e.drivers))return e.drivers;if(e&&typeof e=="object"){const t=Object.values(e).filter(n=>n&&typeof n=="object");if(t.length)return t}return[]}const h={fetch:async function(e,t={}){try{const n=await fetch(e,{...t,credentials:"include"}),r=n.headers.get("content-type")?.includes("application/json")?await n.json():await n.text();if(!n.ok)throw new Error(r.message||`HTTP ${n.status}`);return r}catch(n){throw console.error("API Error:",n),new Error(n.message||"Operasi gagal")}},fetchAssets:()=>h.fetch("/api/assets",{cache:"no-store"}),fetchDrivers:()=>h.fetch("/api/drivers",{cache:"no-store"}),fetchAllBookings:()=>h.fetch("/api/bookings"),fetchAllRequests:()=>h.fetch("/api/requests"),approveRequest:(e,t,n)=>h.fetch(`/api/requests/${e}/approve`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({approvedBy:t,driver:n})}),rejectRequest:(e,t)=>h.fetch(`/api/requests/${e}/reject`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({rejectionReason:t})})};function X(){const e=document.querySelectorAll("th.sortable");if(!e.length)return;const t={column:null,direction:"asc"};e.forEach(n=>{const s=n.cloneNode(!0);n.parentNode.replaceChild(s,n),s.addEventListener("click",function(){const r=this.getAttribute("data-sort"),o=this.closest("table").querySelector("tbody").id;if(document.querySelectorAll("th.sortable").forEach(a=>{const c=a.querySelector(".sort-icon");c&&(c.innerHTML='<i class="fa fa-sort"></i>'),a.classList.remove("sort-asc","sort-desc")}),t.column===r?t.direction=t.direction==="asc"?"desc":"asc":(t.column=r,t.direction="asc"),t.direction==="asc"){this.classList.add("sort-asc");const a=this.querySelector(".sort-icon");a&&(a.innerHTML='<i class="fa fa-sort-up"></i>')}else{this.classList.add("sort-desc");const a=this.querySelector(".sort-icon");a&&(a.innerHTML='<i class="fa fa-sort-down"></i>')}fe(o,r,t.direction)})})}function fe(e,t,n){const s=document.getElementById(e);if(!s)return;const r=Array.from(s.querySelectorAll("tr"));if(r.length===0)return;const o=r.sort((a,c)=>{let d,l;switch(t){case"created":{d=j(a.cells[0].textContent.trim()),l=j(c.cells[0].textContent.trim());break}case"type":{const i=e==="master-asset-table"?2:1;d=a.cells[i].textContent.trim().toLowerCase(),l=c.cells[i].textContent.trim().toLowerCase();break}case"plate":{const i=e==="master-asset-table"?3:-1;i>=0&&(d=a.cells[i].textContent.trim().toLowerCase(),l=c.cells[i].textContent.trim().toLowerCase());break}case"aset":{const i=e==="request-list-table"?2:1;d=a.cells[i].textContent.trim().toLowerCase(),l=c.cells[i].textContent.trim().toLowerCase();break}case"peminjam":case"pemakai":{const i=e==="request-list-table"?3:2;d=a.cells[i].textContent.trim().toLowerCase(),l=c.cells[i].textContent.trim().toLowerCase();break}case"tanggal":{const i=e==="request-list-table"?4:3;d=j(a.cells[i].textContent.trim()),l=j(c.cells[i].textContent.trim());break}case"status":{if(e!=="request-list-table"){d="",l="";break}d=a.cells[5].textContent.trim().toLowerCase(),l=c.cells[5].textContent.trim().toLowerCase();break}case"gedung":case"kendaraan":{d=a.cells[1].textContent.trim().toLowerCase(),l=c.cells[1].textContent.trim().toLowerCase();break}case"barang":{d=a.cells[4].textContent.trim().toLowerCase(),l=c.cells[4].textContent.trim().toLowerCase();break}case"supir":{d=a.cells[4].textContent.trim().toLowerCase(),l=c.cells[4].textContent.trim().toLowerCase();break}case"keterangan":{d=a.cells[5].textContent.trim().toLowerCase(),l=c.cells[5].textContent.trim().toLowerCase();break}case"code":{d=a.cells[0].textContent.trim().toLowerCase(),l=c.cells[0].textContent.trim().toLowerCase();break}case"name":{d=a.cells[1].textContent.trim().toLowerCase(),l=c.cells[1].textContent.trim().toLowerCase();break}case"no-telp":{d=a.cells[2].textContent.trim().toLowerCase(),l=c.cells[2].textContent.trim().toLowerCase();break}case"qty":{d=parseInt(a.cells[3].textContent.trim())||0,l=parseInt(c.cells[3].textContent.trim())||0;break}case"detail":{const i=e==="master-asset-table"?5:4;d=a.cells[i].textContent.trim().toLowerCase(),l=c.cells[i].textContent.trim().toLowerCase();break}default:d="",l=""}let u=0;return d instanceof Date&&l instanceof Date||typeof d=="number"&&typeof l=="number"?u=d-l:u=String(d).localeCompare(String(l),"id"),n==="asc"?u:-u});for(;s.firstChild;)s.removeChild(s.firstChild);o.forEach(a=>s.appendChild(a))}function j(e){try{if(e.includes("-")&&(e=e.split("-")[0].trim()),/\d{1,2}\/\d{1,2}\/\d{4}/.test(e)){const[r,o,a]=e.split("/").map(Number);return new Date(a,o-1,r)}if(/\d{1,2}-\d{1,2}-\d{4}/.test(e)){const[r,o,a]=e.split("-").map(Number);return new Date(a,o-1,r)}const t=e.split(" "),n={Januari:0,Februari:1,Maret:2,April:3,Mei:4,Juni:5,Juli:6,Agustus:7,September:8,Oktober:9,November:10,Desember:11};if(t.length>=3){const r=parseInt(t[0],10),o=n[t[1]],a=parseInt(t[2],10);if(!isNaN(r)&&o!==void 0&&!isNaN(a))return new Date(a,o,r)}const s=new Date(e);return isNaN(s.getTime())?e:s}catch(t){return console.error("Error parsing date:",t),e}}const w={renderBookingList:function(e,t){const n=`${e}-list-table`,s=document.getElementById(n);if(!s)return;s.innerHTML="";const r=[...t].sort((a,c)=>new Date(c.startDate)-new Date(a.startDate));if(r.length===0){s.innerHTML='<tr><td colspan="7" class="text-center py-4 text-gray-500">Tidak ada data untuk filter ini.</td></tr>';return}const o="px-6 py-3 whitespace-nowrap text-sm text-gray-500";s.innerHTML=r.map(a=>{const c=new Date(a.startDate),d=new Date(a.endDate);let l=c.toLocaleDateString("id-ID");c.toDateString()!==d.toDateString()&&(l+=` - ${d.toLocaleDateString("id-ID")}`);const u=a.createdAt?new Date(a.createdAt).toLocaleDateString("id-ID"):"-";if(e==="gedung"){const i=ye(a.borrowedItems);return`<tr class="table-row cursor-pointer" data-booking-id="${a._id}">
                    <td class="${o}">${u}</td>
                    <td class="${o} font-medium text-gray-900">${a.assetName}</td>
                    <td class="${o}">${a.userName}</td>
                    <td class="${o}">${l}</td>
                    <td class="${o}">${i}</td>
                    <td class="${o}">${a.notes||"-"}</td>
                    <td class="${o} text-right">
                        <button type="button" class="mr-2"><i class="fas fa-pen-to-square text-emerald-700 hover:text-emerald-800 btn btn-edit" data-id="${a._id}"></i></button>
                        <button type="button"><i class="fas fa-trash color-gedung hover:opacity-80 btn btn-delete" data-id="${a._id}"></i></button>
                    </td>
                </tr>`}else{const i=typeof a.driver=="object"&&a.driver?a.driver.name:a.driver||"-",m=a.assetPlate?` (${a.assetPlate})`:"";return`<tr class="table-row cursor-pointer" data-booking-id="${a._id}">
                    <td class="${o}">${u}</td>
                    <td class="${o} font-medium text-gray-900">${a.assetName}${m}</td>
                    <td class="${o}">${a.userName}</td>
                    <td class="${o}">${l}</td>
                    <td class="${o}">${i}</td>
                    <td class="${o}">${a.notes||"-"}</td>
                    <td class="${o} text-right">
                        <button type="button" class="mr-2"><i class="fas fa-pen-to-square text-emerald-700 hover:text-emerald-800 btn btn-edit" data-id="${a._id}"></i></button>
                        <button type="button"><i class="fas fa-trash color-gedung hover:opacity-80 btn btn-delete" data-id="${a._id}"></i></button>
                    </td>
                </tr>`}}).join(""),X()},renderRequestList:function(e){const t=document.getElementById("request-list-table");if(!t)return;t.innerHTML="";const n=[...e].sort((s,r)=>new Date(r.createdAt)-new Date(s.createdAt));if(n.length===0){t.innerHTML='<tr><td colspan="7" class="px-6 py-3 text-center text-gray-500">Tidak ada data</td></tr>';return}t.innerHTML=n.map(s=>{const r=s.createdAt?new Date(s.createdAt).toLocaleDateString("id-ID"):"-",o=new Date(s.startDate).toLocaleDateString("id-ID"),a="px-6 py-3 whitespace-nowrap text-sm text-gray-500",c=s.status==="pending"?"bg-yellow-100 text-yellow-800":s.status==="approved"?"bg-green-100 text-green-800":"bg-red-100 text-red-800",d=s.status==="pending"?"Pending":s.status==="approved"?"Diterima":"Ditolak";return`<tr class="table-row cursor-pointer hover:bg-gray-100" data-request-id="${s._id}">
                <td class="${a}">${r}</td>
                <td class="${a}">${s.bookingType==="gedung"?"Gedung":"Kendaraan"}</td>
                <td class="${a}">${s.assetName||"-"}</td>
                <td class="${a}">${s.userName||"-"}</td>
                <td class="${a}">${o}</td>
                <td class="${a}"><span class="px-2 py-1 rounded text-xs font-semibold ${c}">${d}</span></td>
                <td class="${a}"><span class="text-xs text-gray-700">${s.requestId||s._id}</span></td>
            </tr>`}).join("")},renderDriverList:function(e){const t=document.getElementById("driver-list-table");if(!t)return;t.innerHTML="";const n=[...e].sort((s,r)=>(s.username||"").localeCompare(r.username||""));if(n.length===0){t.innerHTML='<tr><td colspan="6" class="px-6 py-3 text-center text-gray-500">Tidak ada data</td></tr>';return}t.innerHTML=n.map(s=>{const r="px-6 py-3 whitespace-nowrap text-sm text-gray-500",o=s.isActive?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600",a=s.isActive?"Aktif":"Tidak Aktif";return`<tr class="cursor-pointer" data-driver-id="${s._id}">
                <td class="${r}">${s.username||"-"}</td>
                <td class="${r}">${s.name||"-"}</td>
                <td class="${r}">${s.email||"-"}</td>
                <td class="${r}">${s.phone||"-"}</td>
                <td class="${r}">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${o}">${a}</span>
                </td>
                <td class="px-6 py-3 text-right text-sm">
                    <div class="flex justify-end gap-3">
                        <button class="btn-edit" data-id="${s._id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${s._id}" title="Hapus"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`}).join("")},renderMasterTable:function(e){const t=document.getElementById("master-asset-table");if(!t)return;t.innerHTML="";const n=[...e].sort((s,r)=>s.name.localeCompare(r.name));if(n.length===0){t.innerHTML='<tr><td colspan="7" class="px-6 py-3 text-center text-gray-500">Tidak ada data</td></tr>';return}t.innerHTML=n.map(s=>{const r="px-6 py-3 whitespace-nowrap text-sm text-gray-500",o="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700",a=s.type==="kendaraan"&&s.plate?s.plate.trim():"-";return`<tr class="cursor-pointer" data-asset-id="${s._id}">
                <td class="${r}">${s.code||"-"}</td>
                <td class="${r}">${s.name||"-"}</td>
                <td class="${r}"><span class="${o}">${s.type||"-"}</span></td>
                <td class="${r}">${a}</td>
                <td class="${r}">${s.num??"-"}</td>
                <td class="${r}">${s.detail||"-"}</td>
                <td class="px-6 py-3 text-right text-sm">
                    <div class="flex justify-end gap-3">
                        <button class="btn-edit" data-id="${s._id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${s._id}" title="Hapus"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`}).join("")},showDetailModal:function(e,t="admin",n){let s=e.assetName;if(e.bookingType==="kendaraan"){const i=e.assetPlate?` (${e.assetPlate})`:"";s=`${e.assetName}${i}`}const r=document.getElementById("modal-title"),o=document.getElementById("modal-body"),a=document.getElementById("modal-detail-event");if(!r||!o||!a){console.error("Modal elements not found");return}r.innerText=`${s}`;const c=new Date(e.startDate),d=new Date(e.endDate);let u=`<p>${ve(c,d,w)}</p>`;if(e.bookingId&&(u+=`<p><strong>Booking ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.bookingId}</code></p>`),u+=`<p><strong>Peminjam:</strong> ${e.userName}</p>`,t==="admin"){if(e.personInCharge&&(u+=`<p><strong>Penanggung Jawab:</strong> ${e.personInCharge}</p>`),e.picPhoneNumber&&(u+=`<p><strong>No. Telepon:</strong> ${e.picPhoneNumber}</p>`),e.bookingType==="gedung")e.activityName&&(u+=`<p><strong>Kegiatan:</strong> ${e.activityName}</p>`),e.borrowedItems&&e.borrowedItems.length>0&&(u+='<p><strong>Barang Dipinjam:</strong></p><ul class="ml-4 list-disc">',e.borrowedItems.forEach(i=>{u+=`<li>${i.assetName} (${i.assetCode}) - ${i.quantity} unit</li>`}),u+="</ul>");else if(e.bookingType==="kendaraan"&&(e.destination&&(u+=`<p><strong>Tujuan:</strong> ${e.destination}</p>`),e.driver&&(typeof e.driver=="object"?e.driver.name:e.driver))){const i=typeof e.driver=="object"?e.driver.name:e.driver;u+=`<p><strong>Supir:</strong> ${i}</p>`}if(e.notes&&(u+=`<p><strong>Keterangan:</strong> ${e.notes}</p>`),e.letterFile&&(u+=`
                    <div style="margin-top: 12px; padding: 12px; background-color: #f3f4f6; border-radius: 6px;">
                        <p style="margin: 0 0 8px 0; font-weight: 600; font-size: 14px;">ðŸ“„ Surat Permohonan</p>
                        <a href="/uploads/${e.letterFile}" 
                           target="_blank" 
                           style="display: inline-block; padding: 8px 12px; background-color: #3b82f6; color: white; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-eye"></i> Lihat Surat
                        </a>
                    </div>
                `),e.createdAt){const i=new Date(e.createdAt),m=e.approvedBy||e.createdBy||"Admin";u+=`<p class="text-sm text-gray-500 mt-2"><em>${i.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})} oleh ${m}</em></p>`}}o.innerHTML=u,a.classList.remove("hidden")},formatDateShort:e=>{const t=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Ags","Sep","Okt","Nov","Des"],n=String(e.getDate()).padStart(2,"0"),s=t[e.getMonth()],r=e.getFullYear();return`${n} ${s} ${r}`},formatTimeDot:e=>{const t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0");return`${t}.${n}`}};function ye(e){return e?Array.isArray(e)&&e.length?e.map(t=>`${t.assetName}: ${t.quantity}`).join(", "):typeof e=="string"&&e.trim()?e:"-":"-"}function ve(e,t,n){const s=e.toDateString()===t.toDateString(),r=n.formatDateShort(e),o=n.formatTimeDot(e),a=n.formatDateShort(t),c=n.formatTimeDot(t);return s?`${r}, ${o}-${c} WIB`:`${r}, ${o} WIB - ${a}, ${c} WIB`}function he(e){const t=document.getElementById("filter-gedung-asset");t&&e.assets&&e.assets.gedung&&(t.innerHTML='<option value="all">Semua Gedung</option>',e.assets.gedung.forEach(a=>{t.innerHTML+=`<option value="${a.code}">${a.name}</option>`}));const n=document.getElementById("filter-gedung-barang");n&&e.assets&&e.assets.barang&&(n.innerHTML='<option value="all">Semua Barang</option>',e.assets.barang.forEach(a=>{n.innerHTML+=`<option value="${a.code}">${a.name}</option>`}));const s=document.getElementById("filter-kendaraan-asset"),r=document.getElementById("filter-kendaraan-driver");s&&e.assets&&e.assets.kendaraan&&(s.innerHTML='<option value="all">Semua Kendaraan</option>',e.assets.kendaraan.forEach(a=>{s.innerHTML+=`<option value="${a.code}">${a.name}</option>`}));const o=A(e.allDrivers);if(r&&o&&o.length>0){const a=o.filter(c=>c.isActive!==!1);r.innerHTML='<option value="all">Semua Supir</option>',a.forEach(c=>{r.innerHTML+=`<option value="${c._id}">${c.name}</option>`})}}function be(){const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`,n=document.getElementById("filter-request-status");n&&(n.value="pending");const s=document.getElementById("filter-gedung-month");s&&(s.value=t);const r=document.getElementById("filter-kendaraan-month");r&&(r.value=t)}function Ee(e,t){const n=document.getElementById("filters-gedung"),s=document.getElementById("filters-kendaraan"),r=document.getElementById("filters-request");if(n){n.addEventListener("input",()=>e("gedung")),n.addEventListener("change",()=>e("gedung"));const o=document.getElementById("filter-gedung-search");o&&o.addEventListener("keyup",()=>e("gedung"))}if(s){s.addEventListener("input",()=>e("kendaraan")),s.addEventListener("change",()=>e("kendaraan"));const o=document.getElementById("filter-kendaraan-search");o&&o.addEventListener("keyup",()=>e("kendaraan"))}r&&(r.addEventListener("input",()=>t()),r.addEventListener("change",()=>t()))}function _(e,t,n){const s=document.getElementById(`filters-${e}`);if(!s)return;const r=s.querySelector(`#filter-${e}-month`),o=s.querySelector(`#filter-${e}-asset`),a=e==="gedung"?s.querySelector("#filter-gedung-barang"):null,c=s.querySelector(`#filter-${e}-search`),d=e==="kendaraan"?s.querySelector("#filter-kendaraan-driver"):null,l=r?r.value:"",u=o?o.value:"all",i=a?a.value:"all",m=c?c.value.trim().toLowerCase():"",g=d?d.value:"all",f=n(t.allBookingsCache,{type:e,month:l,asset:u,barang:i,driver:g,searchQuery:m});w.renderBookingList(e,f)}function P(e,t){return e.filter(n=>{if(n.bookingType!==t.type)return!1;if(t.month){const s=new Date(n.startDate),r=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0");if(`${r}-${o}`!==t.month)return!1}if(t.asset&&t.asset!=="all"&&n.assetCode!==t.asset||t.barang&&t.barang!=="all"&&!(Array.isArray(n.borrowedItems)&&n.borrowedItems.some(r=>r.assetCode===t.barang)))return!1;if(t.driver&&t.driver!=="all"){const s=typeof n.driver=="object"&&n.driver?n.driver._id:n.driver;if(!s||s!==t.driver)return!1}if(t.searchQuery){const s=n.assetName&&n.assetName.toLowerCase().includes(t.searchQuery),r=n.userName&&n.userName.toLowerCase().includes(t.searchQuery),o=n.notes&&n.notes.toLowerCase().includes(t.searchQuery);let a=!1;if(n.bookingType==="gedung"&&Array.isArray(n.borrowedItems)&&n.borrowedItems.map(d=>`${d.assetName} ${d.assetCode}`).join(" ").toLowerCase().includes(t.searchQuery)&&(a=!0),n.bookingType==="kendaraan"&&((typeof n.driver=="object"&&n.driver?n.driver.name:n.driver||"").toLowerCase().includes(t.searchQuery)&&(a=!0),n.destination&&n.destination.toLowerCase().includes(t.searchQuery)&&(a=!0)),!(s||r||o||a))return!1}return!0})}function H(e){const t=document.getElementById("filters-request");if(!t)return;const n=t.querySelector("#filter-request-type"),s=t.querySelector("#filter-request-status"),r=t.querySelector("#filter-request-month"),o=t.querySelector("#filter-request-search"),a=n?n.value:"all",c=s?s.value:"all",d=r?r.value:"",l=o?o.value.trim().toLowerCase():"",u=e.allRequestsCache.filter(i=>{if(a!=="all"&&i.bookingType!==a||c!=="all"&&i.status!==c)return!1;if(d){const m=new Date(i.startDate),g=m.getFullYear(),f=String(m.getMonth()+1).padStart(2,"0");if(`${g}-${f}`!==d)return!1}if(l){const m=i.assetName?.toLowerCase().includes(l),g=i.userName?.toLowerCase().includes(l),f=i.notes?i.notes.toLowerCase().includes(l):!1,p=i.requestId?i.requestId.toLowerCase().includes(l):!1,y=i._id?String(i._id).toLowerCase().includes(l):!1;if(!(m||g||f||p||y))return!1}return!0});w.renderRequestList(u)}function we(e,t){const n=document.getElementById("filter-driver-search");n&&(n.addEventListener("input",e),n.addEventListener("keyup",e));const s=document.getElementById("master-filter-type"),r=document.getElementById("master-search");s&&s.addEventListener("change",t),r&&(r.addEventListener("input",t),r.addEventListener("keyup",t))}function W(e){const t=document.getElementById("filter-driver-search"),n=t?t.value.trim().toLowerCase():"",s=Array.isArray(e.allDrivers)?e.allDrivers:[],r=n?s.filter(o=>[o.username,o.name,o.phone,o.email].map(c=>(c||"").toString().toLowerCase()).some(c=>c.includes(n))):s;w.renderDriverList(r)}function V(e){const t=document.getElementById("master-filter-type"),n=document.getElementById("master-search"),s=t?t.value:"all",r=n?n.value.trim().toLowerCase():"";let o=Array.isArray(e.allAssetsCache)?[...e.allAssetsCache]:[];s&&s!=="all"&&(o=o.filter(a=>a.type===s)),r&&(o=o.filter(a=>[a.code,a.name,a.detail].map(d=>(d||"").toString().toLowerCase()).some(d=>d.includes(r)))),w.renderMasterTable(o)}function C(e=null){const t=B(),n=document.getElementById("gedung-barang-select");if(!t||!n)return;const s=Array.isArray(t.assets?.barang)?t.assets.barang:[],r=n.value;n.innerHTML="",s.forEach(o=>{const a=e?e.get(o.code)??0:Number(o.num||0),c=document.createElement("option");c.value=o.code,c.textContent=`${o.name} (${o.code})${Number.isFinite(a)?` - tersisa ${a}`:""}`,c.disabled=a<=0,n.appendChild(c)}),r&&(n.value=r)}function N(e){if(!e)return;e.__barangItems=new Map;const t=e.querySelector("#gedung-barang-chips");t&&(t.innerHTML=""),C(),$(e,null)}function Z(e,t,n,s){if(!e)return;e.__barangItems||(e.__barangItems=new Map),e.__barangItems.set(t,{assetCode:t,assetName:n,quantity:s});const r=e.querySelector("#gedung-barang-chips");if(!r)return;const o=document.createElement("span");o.className="inline-flex items-center bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full",o.dataset.code=t,o.innerHTML=`
        <span class="mr-1 font-semibold">${n}: ${s}</span>
        <button type="button" class="ml-1 text-emerald-800 hover:text-red-600" title="Hapus">&times;</button>
    `,r.querySelectorAll("span[data-code]").forEach(a=>{a.dataset.code===t&&a.remove()}),r.appendChild(o),o.querySelector("button")?.addEventListener("click",()=>{e.__barangItems.delete(t),o.remove(),E(e)})}function Ie(e,t,n=null){const s=B();if(!s||!e||!t)return new Map;const r=new Map;s.allBookingsCache.forEach(a=>{if(n&&a._id===n)return;const c=new Date(a.startDate),d=new Date(a.endDate);e<d&&t>c&&Array.isArray(a.borrowedItems)&&a.borrowedItems.forEach(l=>{const u=l.assetCode,i=Number(l.quantity||0);!u||!Number.isFinite(i)||i<=0||r.set(u,(r.get(u)||0)+i)})});const o=new Map;return(s.assets?.barang||[]).forEach(a=>{const c=Number(a.num||0),d=r.get(a.code)||0;o.set(a.code,Math.max(0,c-d))}),o}function $(e,t){const n=e?.querySelector("#gedung-barang-select"),s=e?.querySelector("#gedung-barang-qty");if(!n||!s)return;const r=n.value||null;let o=0;if(t&&r&&(o=t.get(r)??0),o<0&&(o=0),s.max=String(o),s.placeholder=o>0?`Qty (maks: ${o})`:"Qty",s.value){const a=Number(s.value);Number.isFinite(a)&&a>o&&(s.value=o||"")}s.disabled=o===0}function E(e){if(!B()||!e)return;const n=e.querySelector("#gedung-use-time")?.checked,s=e.querySelector("#gedung-mulai-tanggal"),r=e.querySelector("#gedung-selesai-tanggal"),o=e.querySelector("#gedung-mulai-jam"),a=e.querySelector("#gedung-selesai-jam"),c=e.querySelector("#gedung-booking-id")?.value||null;if(!s||!r)return;let d,l;if(n){if(!s.value||!r.value||!o?.value||!a?.value){C(),e.__barangAvailability=null,$(e,null);return}d=new Date(`${s.value}T${o.value}`),l=new Date(`${r.value}T${a.value}`)}else{if(!s.value||!r.value){C(),e.__barangAvailability=null,$(e,null);return}d=new Date(s.value),l=new Date(r.value),l.setHours(23,59,59,999)}if(isNaN(d)||isNaN(l)||d>=l){C(),e.__barangAvailability=null,$(e,null);return}const u=Ie(d,l,c);(e.__barangItems?[...e.__barangItems.values()]:[]).forEach(m=>{const g=u.get(m.assetCode)??0;u.set(m.assetCode,Math.max(0,g-Number(m.quantity||0)))}),e.__barangAvailability=u,C(u),$(e,u)}function ke(e,t){e&&(N(e),t?.borrowedItems&&Array.isArray(t.borrowedItems)&&t.borrowedItems.forEach(n=>{Z(e,n.assetCode,n.assetName,n.quantity)}),E(e))}function xe(){const e=document.getElementById("form-gedung");if(!e)return;const t=e.querySelector("#gedung-use-time"),n=e.querySelector("#gedung-time-inputs"),s=e.querySelector("#gedung-mulai-tanggal"),r=e.querySelector("#gedung-selesai-tanggal"),o=e.querySelector("#gedung-mulai-jam"),a=e.querySelector("#gedung-selesai-jam"),c=e.querySelector("#gedung-barang-add"),d=e.querySelector("#gedung-barang-qty"),l=e.querySelector("#gedung-barang-select");N(e),t&&n&&t.addEventListener("change",()=>{n.classList.toggle("hidden",!t.checked),E(e),L()}),s&&s.addEventListener("change",()=>{r&&(r.min=s.value),L(),E(e)}),r&&r.addEventListener("change",()=>{L(),E(e)}),o&&o.addEventListener("change",()=>{L(),E(e)}),a&&a.addEventListener("change",()=>{L(),E(e)}),l?.addEventListener("change",()=>$(e,e.__barangAvailability||null)),d?.addEventListener("input",()=>$(e,e.__barangAvailability||null)),c?.addEventListener("click",()=>{const u=B();if(!u)return alert("Data aset belum siap.");const i=l?.value,m=Number(d?.value),g=(u.assets?.barang||[]).find(y=>y.code===i);if(!g)return alert("Pilih barang.");if(!Number.isFinite(m)||m<=0)return alert("Masukkan qty valid.");const p=(e.__barangAvailability||new Map).get(i)??0;if(m>p)return alert(`Qty melebihi stok tersedia (${p}).`);Z(e,g.code,g.name,m),d&&(d.value=""),E(e)}),E(e)}function L(){const e=B();if(!e)return;const t=document.getElementById("gedung-name"),n=document.getElementById("gedung-mulai-tanggal"),s=document.getElementById("gedung-selesai-tanggal"),r=document.getElementById("gedung-mulai-jam"),o=document.getElementById("gedung-selesai-jam"),a=document.getElementById("gedung-use-time")?.checked,c=document.getElementById("gedung-booking-id")?.value||null;if(!t||!n?.value||!s?.value)return;let d,l;if(a&&r?.value&&o?.value?(d=new Date(`${n.value}T${r.value}`),l=new Date(`${s.value}T${o.value}`)):(d=new Date(`${n.value}T07:00`),l=new Date(`${s.value}T16:00`)),isNaN(d)||isNaN(l)||d>=l)return;const u=new Set;(e.allBookingsCache||[]).forEach(m=>{if(m.bookingType!=="gedung"||c&&m._id===c)return;const g=new Date(m.startDate),f=new Date(m.endDate);d<f&&l>g&&u.add(m.assetCode)});const i=t.value;Array.from(t.options).forEach(m=>{m.value&&u.has(m.value)?(m.disabled=!0,m.text=m.text.replace(" (Tidak Tersedia)","")+" (Tidak Tersedia)"):m.value&&(m.disabled=!1,m.text=m.text.replace(" (Tidak Tersedia)",""))}),i&&!u.has(i)&&(t.value=i)}function O(e=null){const t=document.getElementById("modal-form-gedung"),n=document.getElementById("form-gedung"),s=document.getElementById("gedung-form-title");if(!(!t||!n)){if(s.textContent=e?"Edit Pinjam Gedung":"Form Pinjam Gedung",n.reset(),N(n),e){document.getElementById("gedung-booking-id").value=e._id||"",document.getElementById("gedung-peminjam").value=e.userName||"",document.getElementById("gedung-name").value=e.assetCode||"",document.getElementById("gedung-penanggung-jawab").value=e.personInCharge||"",document.getElementById("gedung-nomor-penanggung-jawab").value=e.picPhoneNumber||"",document.getElementById("gedung-kegiatan").value=e.activityName||"",document.getElementById("gedung-keterangan").value=e.notes||"",document.getElementById("gedung-mulai-tanggal").value=D(e.startDate),document.getElementById("gedung-selesai-tanggal").value=D(e.endDate);const r=D(e.startDate);r&&(document.getElementById("gedung-selesai-tanggal").min=r),ke(n,e),L()}else E(n);t.classList.remove("hidden")}}function $e(){const e=document.getElementById("form-kendaraan");if(!e)return;const t=e.querySelector("#kendaraan-use-time"),n=e.querySelector("#kendaraan-time-inputs"),s=e.querySelector("#kendaraan-mulai-tanggal"),r=e.querySelector("#kendaraan-selesai-tanggal"),o=e.querySelector("#kendaraan-mulai-jam"),a=e.querySelector("#kendaraan-selesai-jam");t&&n&&t.addEventListener("change",()=>{n.classList.toggle("hidden",!t.checked),T()}),s&&s.addEventListener("change",()=>{r&&(r.min=s.value),T()}),r&&r.addEventListener("change",()=>{T()}),o&&o.addEventListener("change",()=>{T()}),a&&a.addEventListener("change",()=>{T()})}function T(){const e=B();if(!e)return;const t=document.getElementById("kendaraan-name"),n=document.getElementById("kendaraan-mulai-tanggal"),s=document.getElementById("kendaraan-selesai-tanggal"),r=document.getElementById("kendaraan-mulai-jam"),o=document.getElementById("kendaraan-selesai-jam"),a=document.getElementById("kendaraan-use-time")?.checked,c=document.getElementById("kendaraan-booking-id")?.value||null;if(!t||!n?.value||!s?.value)return;let d,l;if(a&&r?.value&&o?.value?(d=new Date(`${n.value}T${r.value}`),l=new Date(`${s.value}T${o.value}`)):(d=new Date(`${n.value}T00:00`),l=new Date(`${s.value}T23:59`)),isNaN(d)||isNaN(l)||d>=l)return;const u=new Set;(e.allBookingsCache||[]).forEach(m=>{if(m.bookingType!=="kendaraan"||c&&m._id===c)return;const g=new Date(m.startDate),f=new Date(m.endDate);d<f&&l>g&&u.add(m.assetCode)});const i=t.value;Array.from(t.options).forEach(m=>{m.value&&u.has(m.value)?(m.disabled=!0,m.text=m.text.replace(" (Tidak Tersedia)","")+" (Tidak Tersedia)"):m.value&&(m.disabled=!1,m.text=m.text.replace(" (Tidak Tersedia)",""))}),i&&!u.has(i)&&(t.value=i)}function K(e=null){const t=document.getElementById("modal-form-kendaraan"),n=document.getElementById("form-kendaraan"),s=document.getElementById("kendaraan-form-title");if(!(!t||!n)){if(s.textContent=e?"Edit Pinjam Kendaraan":"Form Pinjam Kendaraan",n.reset(),e){document.getElementById("kendaraan-booking-id").value=e._id||"",document.getElementById("kendaraan-peminjam").value=e.userName||"",document.getElementById("kendaraan-name").value=e.assetCode||"",document.getElementById("kendaraan-penanggung-jawab").value=e.personInCharge||"",document.getElementById("kendaraan-nomor-penanggung-jawab").value=e.picPhoneNumber||"",document.getElementById("kendaraan-tujuan").value=e.destination||"",document.getElementById("kendaraan-keterangan").value=e.notes||"",document.getElementById("kendaraan-mulai-tanggal").value=D(e.startDate),document.getElementById("kendaraan-selesai-tanggal").value=D(e.endDate);const r=D(e.startDate);r&&(document.getElementById("kendaraan-selesai-tanggal").min=r),e.driver&&(document.getElementById("kendaraan-supir").value=typeof e.driver=="object"?e.driver._id:e.driver),T()}t.classList.remove("hidden")}}function J(e=null){const t=document.getElementById("modal-asset"),n=document.getElementById("form-asset"),s=document.getElementById("asset-form-title");if(!t||!n||!s){console.error("Asset modal elements not found");return}s.textContent=e?"Edit Aset":"Tambah Aset",n.reset();const r=document.getElementById("asset-id");if(r&&(r.value=""),e){const o=document.getElementById("asset-id"),a=document.getElementById("asset-code"),c=document.getElementById("asset-name"),d=document.getElementById("asset-type"),l=document.getElementById("asset-detail"),u=document.getElementById("asset-plate"),i=document.getElementById("asset-num"),m=document.getElementById("asset-jenis-bmn"),g=document.getElementById("asset-jenis-bmn-search"),f=document.getElementById("asset-kode-bmn");o&&(o.value=e._id||""),a&&(a.value=e.code||""),c&&(c.value=e.name||""),d&&(d.value=e.type||""),l&&(l.value=e.detail||""),u&&(u.value=e.plate||""),i&&e.num!==void 0&&e.num!==null&&(i.value=e.num),m&&(m.value=e.jenis_bmn||""),g&&(g.value=e.jenis_bmn||""),f&&(f.value=e.kode_bmn||""),q(e.type)}else q("gedung");Be(),t.classList.remove("hidden")}function q(e){const t=document.getElementById("asset-num-wrapper"),n=document.getElementById("asset-num"),s=document.getElementById("asset-plate-wrapper"),r=document.getElementById("asset-plate");if(t&&n){const o=e==="barang";t.classList.toggle("hidden",!o),n.placeholder="Qty (misal: 40)"}if(s&&r){const o=e==="kendaraan";s.classList.toggle("hidden",!o),r.placeholder="Contoh: B 1234 CD"}}let F=[];async function Be(){try{F.length===0&&(F=await h.fetch("/api/assets/bmn/list"));const e=document.getElementById("asset-jenis-bmn-search"),t=document.getElementById("asset-jenis-bmn-list");if(!e||!t)return;e.addEventListener("input",n=>{const s=n.target.value.toLowerCase().trim();if(!s){t.classList.add("hidden");return}const r=F.filter(o=>o.jenis_bmn.toLowerCase().includes(s)||o.kode_bmn.toLowerCase().includes(s));if(r.length===0){t.innerHTML='<div class="p-2 text-gray-500">Tidak ada hasil</div>',t.classList.remove("hidden");return}t.innerHTML=r.map(o=>`
                <div class="p-2 border-b cursor-pointer hover:bg-blue-50" data-kode="${o.kode_bmn}" data-jenis="${o.jenis_bmn}">
                    <div class="font-semibold text-sm">${o.jenis_bmn}</div>
                    <div class="text-xs text-gray-500">${o.kode_bmn}</div>
                </div>
            `).join(""),t.classList.remove("hidden"),t.querySelectorAll("div[data-kode]").forEach(o=>{o.addEventListener("click",()=>{const a=o.getAttribute("data-jenis"),c=o.getAttribute("data-kode");document.getElementById("asset-jenis-bmn-search").value=a,document.getElementById("asset-jenis-bmn").value=a,document.getElementById("asset-kode-bmn").value=c,t.classList.add("hidden")})})}),document.addEventListener("click",n=>{!n.target.closest("#asset-jenis-bmn-search")&&!n.target.closest("#asset-jenis-bmn-list")&&t.classList.add("hidden")})}catch(e){console.error("Error initializing BMN search:",e)}}function Le(){const e=document.getElementById("asset-type");e&&e.addEventListener("change",t=>{q(t.target.value)})}function z(e=null){const t=document.getElementById("modal-form-driver"),n=document.getElementById("form-driver"),s=document.getElementById("driver-form-title"),r=document.getElementById("driver-generated-password-display");if(!t||!n||!s){console.error("Driver modal elements not found");return}s.textContent=e?"Edit Supir":"Tambah Supir",n.reset(),r&&r.classList.add("hidden");const o=document.getElementById("driver-id");if(o&&(o.value=""),e){const a=document.getElementById("driver-id"),c=document.getElementById("driver-username"),d=document.getElementById("driver-name"),l=document.getElementById("driver-email"),u=document.getElementById("driver-phone");a&&(a.value=e._id||""),c&&(c.value=e.username||""),d&&(d.value=e.name||""),l&&(l.value=e.email||""),u&&(u.value=e.phone||"");const i=document.getElementById("driver-status-wrapper"),m=document.getElementById("driver-status");i&&m&&(i.classList.remove("hidden"),m.value=e.isActive?"true":"false")}else{const a=document.getElementById("driver-status-wrapper");a&&a.classList.add("hidden")}t.classList.remove("hidden")}const v=window.location.origin;function Te(){const e=document.getElementById("form-gedung");e&&e.addEventListener("submit",async r=>{r.preventDefault();const o=document.getElementById("gedung-booking-id").value||null,a=document.getElementById("gedung-use-time").checked,c=document.getElementById("gedung-mulai-tanggal").value,d=document.getElementById("gedung-selesai-tanggal").value,l=document.getElementById("gedung-mulai-jam").value,u=document.getElementById("gedung-selesai-jam").value;let i,m;a&&c&&d&&l&&u?(i=new Date(`${c}T${l}`),m=new Date(`${d}T${u}`)):(i=c?new Date(c):null,m=d?new Date(d):null,m&&m.setHours(23,59,59,999));const g=document.getElementById("gedung-name").value,y=((window.__adminState||{}).assets?.gedung||[]).find(x=>x.code===g),I=y?y.name:g,k={bookingType:"gedung",userName:document.getElementById("gedung-peminjam").value,assetCode:g,assetName:I,personInCharge:document.getElementById("gedung-penanggung-jawab").value,picPhoneNumber:document.getElementById("gedung-nomor-penanggung-jawab").value,activityName:document.getElementById("gedung-kegiatan").value,notes:document.getElementById("gedung-keterangan").value,startDate:i,endDate:m,borrowedItems:Array.from(e.__barangItems?.values?.()||[])};if(!k.userName||!k.assetCode||!k.startDate||!k.endDate){alert("Nama peminjam, gedung, dan tanggal wajib diisi.");return}try{const x=o?"PUT":"POST",M=o?`${v}/api/bookings/${o}`:`${v}/api/bookings`,Q=await fetch(M,{method:x,headers:{"Content-Type":"application/json"},body:JSON.stringify(k),credentials:"include"});if(!Q.ok){const se=await Q.json();throw new Error(se.message||"Gagal menyimpan")}alert(`Peminjaman gedung berhasil ${o?"diperbarui":"ditambahkan"}.`),document.getElementById("modal-form-gedung").classList.add("hidden"),window.initializeApp?.()}catch(x){alert(`Gagal: ${x.message}`)}});const t=document.getElementById("form-kendaraan");t&&t.addEventListener("submit",async r=>{r.preventDefault();const o=document.getElementById("kendaraan-booking-id").value||null,a=document.getElementById("kendaraan-name").value,l=((window.__adminState||{}).assets?.kendaraan||[]).find(m=>m.code===a),u=l?l.name:a,i={bookingType:"kendaraan",userName:document.getElementById("kendaraan-peminjam").value,assetCode:a,assetName:u,personInCharge:document.getElementById("kendaraan-penanggung-jawab").value,picPhoneNumber:document.getElementById("kendaraan-nomor-penanggung-jawab").value,destination:document.getElementById("kendaraan-tujuan").value,notes:document.getElementById("kendaraan-keterangan").value,driver:document.getElementById("kendaraan-supir").value||null,startDate:new Date(document.getElementById("kendaraan-mulai-tanggal").value),endDate:new Date(document.getElementById("kendaraan-selesai-tanggal").value)};if(!i.userName||!i.assetCode){alert("Nama peminjam dan kendaraan wajib diisi.");return}try{const m=o?"PUT":"POST",g=o?`${v}/api/bookings/${o}`:`${v}/api/bookings`,f=await fetch(g,{method:m,headers:{"Content-Type":"application/json"},body:JSON.stringify(i),credentials:"include"});if(!f.ok){const p=await f.json();throw new Error(p.message||"Gagal menyimpan")}alert(`Peminjaman kendaraan berhasil ${o?"diperbarui":"ditambahkan"}.`),document.getElementById("modal-form-kendaraan").classList.add("hidden"),window.initializeApp?.()}catch(m){alert(`Gagal: ${m.message}`)}});const n=document.getElementById("form-driver");if(n){const r=async o=>{o.preventDefault();const a=document.getElementById("driver-id").value||null,c=document.getElementById("driver-username"),d=document.getElementById("driver-name"),l=document.getElementById("driver-email"),u=document.getElementById("driver-phone"),i=document.getElementById("driver-status"),m={username:c?.value?.trim()||"",name:d?.value?.trim()||"",email:l?.value?.trim()||"",phone:u?.value?.trim()||""};if(a&&i&&!document.getElementById("driver-status-wrapper").classList.contains("hidden")&&(m.isActive=i.value==="true"),!m.username||!m.name||!m.email){alert("Username, nama, dan email supir wajib diisi.");return}try{const g=a?"PUT":"POST",f=a?`${v}/api/drivers/${a}`:`${v}/api/drivers`,p=await fetch(f,{method:g,headers:{"Content-Type":"application/json"},body:JSON.stringify(m),credentials:"include"});if(!p.ok){const I=await p.json();throw new Error(I.message||"Gagal menyimpan")}const y=await p.json();if(!a&&y.password){const I=document.getElementById("driver-generated-password-display"),k=document.getElementById("driver-generated-password-text"),x=document.getElementById("driver-copy-password-btn");I&&k&&(k.textContent=y.password,I.classList.remove("hidden"),x&&(x.onclick=M=>{M.preventDefault(),navigator.clipboard.writeText(y.password),alert("Password disalin ke clipboard")}))}else alert(`Supir berhasil ${a?"diperbarui":"ditambahkan"}.`),document.getElementById("modal-form-driver").classList.add("hidden"),window.initializeApp?.()}catch(g){console.error("âŒ Error:",g),alert(`Gagal: ${g.message}`)}};n.addEventListener("submit",r)}else console.warn("âŒ Driver form not found");const s=document.getElementById("form-asset");s&&s.addEventListener("submit",async r=>{r.preventDefault();const o=document.getElementById("asset-id").value||null,a={name:document.getElementById("asset-name").value.trim(),type:document.getElementById("asset-type").value,detail:document.getElementById("asset-detail").value.trim(),plate:document.getElementById("asset-plate").value.trim()||"",jenis_bmn:document.getElementById("asset-jenis-bmn").value.trim()||"",kode_bmn:document.getElementById("asset-kode-bmn").value.trim()||""},c=document.getElementById("asset-num").value;if(c!==""&&(a.num=Number(c)),!a.name){alert("Nama aset wajib diisi.");return}try{const d=o?"PUT":"POST",l=o?`${v}/api/assets/${o}`:`${v}/api/assets`,u=await fetch(l,{method:d,headers:{"Content-Type":"application/json"},body:JSON.stringify(a),credentials:"include"});if(!u.ok){const i=await u.json();throw new Error(i.message||"Gagal menyimpan")}alert(`Aset berhasil ${o?"diperbarui":"ditambahkan"}.`),document.getElementById("modal-asset").classList.add("hidden"),window.initializeApp?.()}catch(d){alert(`Gagal: ${d.message}`)}})}function De(e){const t=document.getElementById("request-list-table");t&&t.addEventListener("click",async a=>{const c=a.target.closest("tr[data-request-id]");if(!c)return;const l=e()?.allRequestsCache?.find(u=>u._id===c.dataset.requestId);l&&window.showRequestDetail&&await window.showRequestDetail(l)});const n=document.getElementById("gedung-list-table");n&&n.addEventListener("click",async a=>{const c=a.target.closest(".btn-edit"),d=a.target.closest(".btn-delete"),l=a.target.closest("tr[data-booking-id]");if(l){if(c){const u=l.dataset.bookingId;try{const i=await fetch(`${v}/api/bookings/${u}`,{credentials:"include"});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const m=await i.json();O(m)}catch(i){console.error("Error loading booking:",i),alert("Gagal memuat data: "+i.message)}}else if(d){const u=l.dataset.bookingId;if(confirm("Hapus peminjaman ini?"))try{await fetch(`${v}/api/bookings/${u}`,{method:"DELETE",credentials:"include"}),alert("Peminjaman berhasil dihapus."),window.initializeApp?.()}catch(i){alert("Gagal menghapus: "+i.message)}}else if(!c&&!d){const i=e()?.allBookingsCache?.find(m=>m._id===l.dataset.bookingId);i&&window.showBookingDetail&&window.showBookingDetail(i,"admin")}}});const s=document.getElementById("kendaraan-list-table");s&&s.addEventListener("click",async a=>{const c=a.target.closest(".btn-edit"),d=a.target.closest(".btn-delete"),l=a.target.closest("tr[data-booking-id]");if(l){if(c){const u=l.dataset.bookingId;try{const i=await fetch(`${v}/api/bookings/${u}`,{credentials:"include"});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const m=await i.json();K(m)}catch(i){console.error("Error loading booking:",i),alert("Gagal memuat data: "+i.message)}}else if(d){const u=l.dataset.bookingId;if(confirm("Hapus peminjaman ini?"))try{await fetch(`${v}/api/bookings/${u}`,{method:"DELETE",credentials:"include"}),alert("Peminjaman berhasil dihapus."),window.initializeApp?.()}catch(i){alert("Gagal menghapus: "+i.message)}}else if(!c&&!d){const i=e()?.allBookingsCache?.find(m=>m._id===l.dataset.bookingId);i&&window.showBookingDetail&&window.showBookingDetail(i,"admin")}}});const r=document.getElementById("driver-list-table");r&&r.addEventListener("click",async a=>{const c=a.target.closest(".btn-edit"),d=a.target.closest(".btn-delete"),l=a.target.closest("tr[data-driver-id]");if(l){if(c){const u=c.dataset.id||l.dataset.driverId;try{const i=await fetch(`${v}/api/drivers/${u}`,{credentials:"include"});if(!i.ok)throw new Error(`HTTP ${i.status}`);if(!i.headers.get("content-type")?.includes("application/json"))throw new Error("Server mengembalikan response yang bukan JSON");const g=await i.json();z(g)}catch(i){console.error("Error:",i),alert("Gagal memuat data supir: "+i.message)}}else if(d){const u=d.dataset.id||l.dataset.driverId;if(confirm("Hapus supir ini?"))try{const i=await fetch(`${v}/api/drivers/${u}`,{method:"DELETE",credentials:"include"});if(!i.ok)throw new Error(`HTTP ${i.status}`);alert("Supir berhasil dihapus."),window.initializeApp?.()}catch(i){console.error("Error:",i),alert("Gagal menghapus: "+i.message)}}}});const o=document.getElementById("master-asset-table");o&&o.addEventListener("click",async a=>{const c=a.target.closest(".btn-edit"),d=a.target.closest(".btn-delete"),l=a.target.closest("tr[data-asset-id]");if(l){if(c){const u=c.dataset.id||l.dataset.assetId;try{const i=await fetch(`${v}/api/assets/${u}`,{credentials:"include"});if(!i.ok)throw new Error(`HTTP ${i.status}`);if(!i.headers.get("content-type")?.includes("application/json"))throw new Error("Server mengembalikan response yang bukan JSON");const g=await i.json();J(g)}catch(i){console.error("Error:",i),alert("Gagal memuat data aset: "+i.message)}}else if(d){const u=d.dataset.id||l.dataset.assetId;if(confirm("Hapus aset ini?"))try{const i=await fetch(`${v}/api/assets/${u}`,{method:"DELETE",credentials:"include"});if(!i.ok)throw new Error(`HTTP ${i.status}`);alert("Aset berhasil dihapus."),window.initializeApp?.()}catch(i){console.error("Error:",i),alert("Gagal menghapus: "+i.message)}}}})}function Ce(){document.querySelectorAll(".modal-backdrop").forEach(e=>{const t=e.querySelector(".modal-close-btn");t&&t.addEventListener("click",()=>{e.classList.add("hidden")});const n=e.querySelector(".modal-reset-btn");n&&n.addEventListener("click",s=>{s.stopPropagation();const r=e.querySelector("form");r&&(r.reset(),r.id==="form-gedung"&&N(r))}),e.addEventListener("click",s=>{s.target===e&&e.classList.add("hidden")})})}function Se(){const e=document.getElementById("btn-add-gedung");e&&e.addEventListener("click",()=>O());const t=document.getElementById("btn-add-kendaraan");t&&t.addEventListener("click",()=>K());const n=document.getElementById("btn-add-driver");n&&n.addEventListener("click",()=>z());const s=document.getElementById("btn-add-asset");s&&s.addEventListener("click",()=>J())}function je(){const e=a=>`
        <input type="hidden" id="${a}-booking-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label for="${a}-peminjam" class="form-label text-sm">Nama Peminjam / Unit</label>
            <input type="text" id="${a}-peminjam" required class="form-input"></div>
            <div><label for="${a}-name" class="form-label text-sm">Nama ${a==="gedung"?"Gedung":"Kendaraan"}</label>
            <select id="${a}-name" required class="form-input"></select></div>
            <div><label for="${a}-penanggung-jawab" class="form-label text-sm">Penanggung Jawab</label>
            <input type="text" id="${a}-penanggung-jawab" required class="form-input"></div>
            <div><label for="${a}-nomor-penanggung-jawab" class="form-label text-sm">Nomor HP</label>
            <input type="tel" id="${a}-nomor-penanggung-jawab" required class="form-input"></div>
            <div><label for="${a}-mulai-tanggal" class="form-label text-sm">Tanggal Mulai</label>
            <input type="date" id="${a}-mulai-tanggal" required class="form-input"></div>
            <div><label for="${a}-selesai-tanggal" class="form-label text-sm">Tanggal Selesai</label>
            <input type="date" id="${a}-selesai-tanggal" required class="form-input"></div>
            <div id="${a}-time-inputs" class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                <div><label for="${a}-mulai-jam" class="form-label text-sm">Jam Mulai</label>
                <input type="time" id="${a}-mulai-jam" class="form-input"></div>
                <div><label for="${a}-selesai-jam" class="form-label text-sm">Jam Selesai</label>
                <input type="time" id="${a}-selesai-jam" class="form-input"></div>
            </div>
            <div class="col-span-2 flex items-center"><input id="${a}-use-time" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
            <label for="${a}-use-time" class="ml-2 block text-sm text-gray-900">Pakai Jam Spesifik</label></div>
        </div>
    `,t=`
        <div><label for="gedung-kegiatan" class="form-label text-sm">Nama Kegiatan (Opsional)</label>
        <input type="text" id="gedung-kegiatan" class="form-input"></div>
        <div><label for="gedung-keterangan" class="form-label text-sm">Keterangan (Opsional)</label>
        <textarea id="gedung-keterangan" rows="2" class="form-input"></textarea></div>
        <div>
            <label class="form-label text-sm">Barang Dipinjam (Opsional)</label>
            <div class="grid grid-cols-5 gap-2 mb-2">
                <select id="gedung-barang-select" class="form-input col-span-3"></select>
                <input id="gedung-barang-qty" type="number" min="1" step="1" class="form-input col-span-1" placeholder="Qty">
                <button type="button" id="gedung-barang-add" class="add-btn col-span-1">Tambah</button>
            </div>
            <div id="gedung-barang-chips" class="flex flex-wrap gap-2 p-2 border rounded-md bg-gray-50 min-h-10 text-sm"></div>
        </div>
        <button type="submit" class="w-full add-btn">Simpan Peminjaman</button>
    `,n=`
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label for="kendaraan-supir" class="form-label text-sm">Supir</label>
            <select id="kendaraan-supir" class="form-input"></select></div>
            <div><label for="kendaraan-tujuan" class="form-label text-sm">Tujuan (Opsional)</label>
            <input type="text" id="kendaraan-tujuan" class="form-input"></div>
        </div>
        <div><label for="kendaraan-keterangan" class="form-label text-sm">Keterangan (Opsional)</label>
        <textarea id="kendaraan-keterangan" rows="2" class="form-input"></textarea></div>
        <button type="submit" class="w-full add-btn">Simpan Peminjaman</button>
    `,s=document.getElementById("form-gedung"),r=document.getElementById("form-kendaraan"),o=document.getElementById("form-asset");if(s&&(s.innerHTML=e("gedung")+t),r&&(r.innerHTML=e("kendaraan")+n),o){o.innerHTML=`
            <input type="hidden" id="asset-id">
            <input type="hidden" id="asset-kode-bmn">
            <div>
                <label for="asset-name" class="form-label text-sm">Nama</label>
                <input id="asset-name" type="text" required class="form-input" placeholder="Nama aset">
            </div>
            <div>
                <label for="asset-type" class="form-label text-sm">Tipe</label>
                <select id="asset-type" required class="form-input">
                    <option value="gedung">Gedung</option>
                    <option value="kendaraan">Kendaraan</option>
                    <option value="barang">Barang</option>
                    <option value="umum">Umum / Lainnya</option>
                </select>
            </div>
            <div>
                <label for="asset-jenis-bmn" class="form-label text-sm">Jenis BMN (Cari berdasarkan nama)</label>
                <input type="text" id="asset-jenis-bmn-search" class="form-input mb-2" placeholder="Ketik untuk mencari...">
                <div id="asset-jenis-bmn-list" class="border rounded max-h-48 overflow-y-auto bg-white hidden"></div>
                <input type="hidden" id="asset-jenis-bmn">
            </div>
            <div id="asset-plate-wrapper" class="hidden">
                <label for="asset-plate" class="form-label text-sm">Plat / No Polisi (Opsional)</label>
                <input id="asset-plate" type="text" class="form-input" placeholder="Contoh: B 1234 CD">
            </div>
            <div id="asset-num-wrapper" class="hidden">
                <label for="asset-num" class="form-label text-sm">Qty / Max</label>
                <input id="asset-num" type="number" min="0" step="1" class="form-input" placeholder="Masukkan angka">
            </div>
            <div>
                <label for="asset-detail" class="form-label text-sm">Detail (Opsional)</label>
                <input id="asset-detail" type="text" class="form-input" placeholder="Kapasitas / keterangan lain">
            </div>
            <button type="submit" class="w-full add-btn">Simpan Aset</button>
        `;const a=o.querySelector("#asset-type");a&&q(a.value)}}function Ae(e){const t=Array.isArray(e.assets?.gedung)?e.assets.gedung:[],n=Array.isArray(e.assets?.kendaraan)?e.assets.kendaraan:[],s=Array.isArray(e.assets?.barang)?e.assets.barang:[];Array.isArray(e.assets?.umum)&&e.assets.umum;const r=A(e.allDrivers),o=document.getElementById("gedung-name");o&&(o.innerHTML='<option value="">Pilih Gedung</option>'+t.map(l=>`<option value="${l.code}">${l.name} (${l.code})</option>`).join(""));const a=document.getElementById("kendaraan-name");a&&(a.innerHTML='<option value="">Pilih Kendaraan</option>'+n.map(l=>{const u=l.plate&&typeof l.plate=="string"&&l.plate.trim()?l.plate.trim():null,i=u?`${l.name} (${u})`:l.name;return`<option value="${l.code}">${i}</option>`}).join(""));const c=document.getElementById("kendaraan-supir");if(c){const l=r.filter(u=>u.isActive!==!1);c.innerHTML='<option value="">Tanpa Supir</option>'+l.map(u=>`<option value="${u._id}">${u.name}</option>`).join("")}const d=document.getElementById("gedung-barang-select");d&&(d.innerHTML='<option value="">Pilih Barang</option>'+s.map(l=>`<option value="${l.code}">${l.name} (${l.code})</option>`).join(""))}async function qe(e,t=null,n,s){if(confirm("Setujui request ini?"))try{const r=t||null;await h.approveRequest(e,"admin",r),alert("Request disetujui dan booking dibuat.");const o=document.getElementById("modal-request-action");o&&o.classList.add("hidden"),await n(),s()}catch(r){alert(`Gagal: ${r.message}`)}}async function Ne(e,t,n){const s=prompt("Masukkan alasan penolakan:");if(s!==null)try{await h.rejectRequest(e,s),alert("Request ditolak.");const r=document.getElementById("modal-request-action");r&&r.classList.add("hidden"),await t(),n()}catch(r){alert(`Gagal: ${r.message}`)}}async function Me(e,t,n,s){const r=new Date(e.startDate),o=new Date(e.endDate),c={pending:{label:"Pending",color:"bg-yellow-100 text-yellow-800"},approved:{label:"Disetujui",color:"bg-green-100 text-green-800"},rejected:{label:"Ditolak",color:"bg-red-100 text-red-800"}}[e.status]||{label:e.status,color:"bg-gray-100 text-gray-800"};let d=`
        <p><strong>ID Request:</strong> ${e.requestId}</p>
        <p><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${c.color}">${c.label}</span></p>
    `;if(e.status==="approved"&&e.bookingId&&(d+=`<p><strong>Booking ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.bookingId}</code></p>`),d+=`
        <p><strong>Tipe:</strong> ${e.bookingType==="gedung"?"Gedung":"Kendaraan"}</p>
        <p><strong>Aset:</strong> ${e.assetName}</p>
        <p><strong>Peminjam:</strong> ${e.userName}</p>
        <p><strong>Penanggung Jawab:</strong> ${e.personInCharge||"-"}</p>
        <p><strong>HP PJ:</strong> ${e.picPhoneNumber||"-"}</p>
        <p><strong>Tanggal Mulai:</strong> ${r.toLocaleDateString("id-ID")}</p>
        <p><strong>Tanggal Selesai:</strong> ${o.toLocaleDateString("id-ID")}</p>
    `,e.bookingType==="gedung")e.activityName&&(d+=`<p><strong>Kegiatan:</strong> ${e.activityName}</p>`),e.borrowedItems&&e.borrowedItems.length>0&&(d+='<p><strong>Barang Dipinjam:</strong><ul class="ml-4 list-disc">',e.borrowedItems.forEach(m=>{d+=`<li>${m.assetName} (${m.assetCode}) - ${m.quantity} unit</li>`}),d+="</ul></p>");else if(e.bookingType==="kendaraan"){if(e.driver){const m=typeof e.driver=="object"?e.driver.name:e.driver;d+=`<p><strong>Supir:</strong> ${m}</p>`}e.destination&&(d+=`<p><strong>Tujuan:</strong> ${e.destination}</p>`)}if(e.notes&&(d+=`<p><strong>Keterangan:</strong> ${e.notes}</p>`),e.letterFile&&(d+=`
            <div style="margin-top: 12px; padding: 12px; background-color: #f3f4f6; border-radius: 6px;">
                <p style="margin: 0 0 8px 0; font-weight: 600; font-size: 14px;">ðŸ“„ Surat Permohonan</p>
                <a href="/uploads/${e.letterFile}" 
                   target="_blank" 
                   style="display: inline-block; padding: 8px 12px; background-color: #3b82f6; color: white; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;">
                    <i class="fas fa-eye"></i> Lihat Surat
                </a>
            </div>
        `),e.status==="rejected"&&e.rejectionReason&&(d+=`<p><strong>Alasan Penolakan:</strong> <span class="text-red-600">${e.rejectionReason}</span></p>`),e.status==="pending"){let m="";if(e.bookingType==="kendaraan"){let g=A(t.allDrivers);if(!g.length)try{const p=await h.fetchDrivers();g=A(p),t.allDrivers=g}catch(p){console.error("Gagal memuat daftar supir:",p)}m=`
                <div class="mt-3">
                    <label for="req-approve-supir" class="form-label text-sm font-semibold">Pilih Supir</label>
                    <select id="req-approve-supir" class="form-input">
                        <option value="">Tanpa Supir</option>
                        ${g.filter(p=>p.isActive===!0||p.isActive===void 0||p.isActive===null).map(p=>`<option value="${p._id}">${p.name}</option>`).join("")}
                    </select>
                </div>
            `}d+=`
            ${m}
            <div style="margin-top: 16px;">
                <button id="btn-approve-req" style="padding: 4px 8px; background-color: #22c55e; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; margin-right: 6px;">
                    <i class="fas fa-check"></i> Setujui
                </button>
                <button id="btn-reject-req" style="padding: 4px 8px; background-color: #ef4444; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-times"></i> Tolak
                </button>
            </div>
        `}const l=document.getElementById("modal-request-title"),u=document.getElementById("modal-request-body"),i=document.getElementById("modal-request-action");l&&(l.innerText="Detail Request"),u&&(u.innerHTML=d,e.status==="pending"&&setTimeout(()=>{const m=document.getElementById("btn-approve-req"),g=document.getElementById("btn-reject-req");if(m){const f=m.cloneNode(!0);m.parentNode.replaceChild(f,m),f.addEventListener("click",()=>{const p=document.getElementById("req-approve-supir"),y=p&&p.value||null;qe(e._id,y,n,s)})}if(g){const f=g.cloneNode(!0);g.parentNode.replaceChild(f,g),f.addEventListener("click",()=>Ne(e._id,n,s))}},0)),i&&i.classList.remove("hidden")}async function _e(){const e=document.getElementById("btn-import-excel"),t=document.getElementById("file-excel-import");!e||!t||(e.addEventListener("click",()=>{t.click()}),t.addEventListener("change",async n=>{const s=n.target.files[0];if(s){if(!s.name.endsWith(".xlsx")&&!s.name.endsWith(".xls")){G("File harus berformat Excel (.xlsx atau .xls)");return}await Pe(s),t.value=""}}))}async function Pe(e){const t=He();document.body.appendChild(t);try{const n=new FormData;n.append("file",e);const s=await fetch("/api/assets/import/excel",{method:"POST",body:n}),r=await s.json();if(t.remove(),!s.ok){G(r.message);return}Fe(r)}catch(n){t.remove(),G(`Gagal upload file: ${n.message}`)}}function He(){const e=document.createElement("div");return e.className="modal-backdrop",e.innerHTML=`
        <div class="modal-content max-w-md text-center">
            <h3 class="text-xl font-bold mb-4 color-gedung">Mengimport Data...</h3>
            <div class="flex justify-center mb-4">
                <div class="animate-spin">
                    <i class="fas fa-spinner text-2xl color-kendaraan"></i>
                </div>
            </div>
            <p class="text-gray-600">Mohon tunggu, sedang memproses file Excel Anda...</p>
        </div>
    `,e}function Fe(e){const t=document.createElement("div");t.className="modal-backdrop";const n=e.failed===0?"text-green-600":"text-orange-600",s=e.errors.slice(0,10).map(r=>`
        <div class="text-xs bg-red-50 p-2 rounded border border-red-200">
            <strong>Baris ${r.row}:</strong> ${Array.isArray(r.errors)?r.errors.join(", "):r.error}
        </div>
    `).join("");t.innerHTML=`
        <div class="modal-content max-w-lg">
            <button class="modal-close-btn">&times;</button>
            <h3 class="text-2xl font-bold mb-4 ${n}">
                ${e.failed===0?"Import Berhasil!":"Import Selesai dengan Error"}
            </h3>
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-2xl font-bold color-kendaraan">${e.success}</div>
                        <div class="text-xs text-gray-600">Berhasil</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <div class="text-2xl font-bold text-green-600">${e.created.length}</div>
                        <div class="text-xs text-gray-600">Baru</div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded">
                        <div class="text-2xl font-bold text-yellow-600">${e.updated.length}</div>
                        <div class="text-xs text-gray-600">Update</div>
                    </div>
                </div>

                ${e.failed>0?`
                    <div>
                        <h4 class="font-bold text-red-600 mb-2">Error (${e.failed}):</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${s}
                            ${e.errors.length>10?`<p class="text-xs text-gray-500">... dan ${e.errors.length-10} error lainnya</p>`:""}
                        </div>
                    </div>
                `:""}

                <p class="text-sm text-gray-600">
                    <i class="fas fa-check-circle text-green-600"></i> Total: ${e.total} baris, ${e.success} berhasil
                </p>
            </div>
        </div>
    `,document.body.appendChild(t),t.querySelector(".modal-close-btn").addEventListener("click",()=>{t.remove()}),t.addEventListener("click",r=>{r.target===t&&t.remove()})}function G(e){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50",t.innerHTML=`
        <strong>Error:</strong> ${e}
        <button onclick="this.parentElement.remove()" class="float-right font-bold">&times;</button>
    `,document.body.appendChild(t)}function Ge(){const e=document.getElementById("btn-export-assets");e&&e.addEventListener("click",()=>Re());const t=document.getElementById("btn-export-gedung");t&&t.addEventListener("click",()=>Y("gedung"));const n=document.getElementById("btn-export-kendaraan");n&&n.addEventListener("click",()=>Y("kendaraan"))}async function Re(){try{const e=document.getElementById("master-filter-type")?.value||"all",t=new URLSearchParams;e!=="all"&&t.append("type",e),ee("Mengexport data aset...");const n=`/api/assets/export/excel${t.toString()?"?"+t.toString():""}`;window.location.href=n,setTimeout(()=>{te("Export berhasil! File sedang didownload...")},500)}catch(e){console.error("Export assets error:",e),ne("Gagal export aset: "+e.message)}}async function Y(e){try{const t=document.getElementById(`filter-${e}-month`)?.value,n=new URLSearchParams;if(n.append("type",e),t){const[r,o]=t.split("-"),a=new Date(r,o-1,1),c=new Date(r,o,0);n.append("startDate",a.toISOString().split("T")[0]),n.append("endDate",c.toISOString().split("T")[0])}ee(`Mengexport data peminjaman ${e}...`);const s=`/api/bookings/export/excel?${n.toString()}`;window.location.href=s,setTimeout(()=>{te("Export berhasil! File sedang didownload...")},500)}catch(t){console.error("Export bookings error:",t),ne("Gagal export peminjaman: "+t.message)}}function ee(e){S();const t=U(e,"info");document.body.appendChild(t)}function te(e){S();const t=U(e,"success");document.body.appendChild(t),setTimeout(S,3e3)}function ne(e){S();const t=U(e,"error");document.body.appendChild(t),setTimeout(S,5e3)}function U(e,t="info"){const n=document.createElement("div");n.id="export-toast";const s={info:"bg-blue-100 border-blue-400 text-blue-700",success:"bg-green-100 border-green-400 text-green-700",error:"bg-red-100 border-red-400 text-red-700"},r={info:'<i class="fas fa-info-circle"></i>',success:'<i class="fas fa-check-circle"></i>',error:'<i class="fas fa-exclamation-circle"></i>'};return n.className=`fixed top-4 right-4 ${s[t]} border px-4 py-3 rounded z-50 shadow-lg`,n.innerHTML=`
        ${r[t]}
        <span class="ml-2">${e}</span>
        <button onclick="this.parentElement.remove()" class="float-right ml-4 font-bold">&times;</button>
    `,n}function S(){const e=document.getElementById("export-toast");e&&e.remove()}document.addEventListener("DOMContentLoaded",async()=>{je(),await re(),pe(),ie(),de(),le(),Oe(),$e(),ae()});function ae(){const e={assets:{},allBookingsCache:[],allRequestsCache:[],allDrivers:[],allAssetsCache:[]};window.__adminState=e;async function t(){try{e.allBookingsCache=await h.fetchAllBookings(),e.allRequestsCache=await h.fetchAllRequests(),e.assets=await h.fetchAssets(),e.allDrivers=await h.fetchDrivers();const n=e.allBookingsCache.filter(r=>r.bookingType==="gedung"),s=e.allBookingsCache.filter(r=>r.bookingType==="kendaraan");e.allAssetsCache=[...e.assets.gedung||[],...e.assets.kendaraan||[],...e.assets.barang||[],...e.assets.umum||[]],Ae(e),E(document.getElementById("form-gedung")),w.renderRequestList(e.allRequestsCache),w.renderBookingList("gedung",n),w.renderBookingList("kendaraan",s),W(e),V(e),X(),he(e),be(),H(e),_("gedung",e,P),_("kendaraan",e,P),Ee(r=>_(r,e,P),()=>H(e)),we(()=>W(e),()=>V(e))}catch(n){console.error("Error loading data:",n)}}window.showBookingDetail=(n,s="admin")=>w.showDetailModal(n,s,e),window.showRequestDetail=n=>Me(n,e,t,()=>H(e)),t(),window.initializeApp=ae}function Oe(){Te(),De(B),Ce(),Se(),Le(),xe(),me(),ge(),_e(),Ge()}window.openGedungModal=O;window.openKendaraanModal=K;window.openDriverModal=z;window.openAssetModal=J;
