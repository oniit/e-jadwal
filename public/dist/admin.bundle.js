(function(){"use strict";const h=window.location.origin;async function J(){try{const e=await fetch(`${h}/auth/me`,{credentials:"include"});if(!e.ok){window.location.href="/login";return}const n=await e.json();if(z(n.name),n.role==="superadmin"){const a=document.getElementById("admin-tab-users");a&&a.classList.remove("hidden")}n.role==="admin"&&n.adminType==="khusus"&&["admin-tab-kendaraan","admin-tab-driver","admin-tab-master","admin-tab-users"].forEach(s=>{const o=document.getElementById(s);o&&o.classList.add("hidden")})}catch(e){console.error("Auth check failed:",e),window.location.href="/login"}}function z(e){const n=document.getElementById("user-name");n&&(n.textContent=e)}function Q(){const e=document.getElementById("btn-logout");e&&e.addEventListener("click",async()=>{try{await fetch(`${h}/auth/logout`,{method:"POST",credentials:"include"}),window.location.href="/"}catch(n){console.error("Logout failed:",n),alert("Logout gagal")}})}function U(){const e=document.getElementById("btn-profile"),n=document.getElementById("modal-profile");e&&n&&e.addEventListener("click",async()=>{try{const a=await fetch(`${h}/auth/me`,{credentials:"include"});if(!a.ok){const r=await a.json().catch(()=>({}));throw new Error(r.message||`HTTP ${a.status}`)}const s=await a.json(),o=s.user||s;document.getElementById("profile-username").value=o.username||"",document.getElementById("profile-name").value=o.name||"",document.getElementById("profile-email").value=o.email||"",document.getElementById("profile-phone").value=o.phone||"",n.classList.remove("hidden")}catch(a){console.error("Load profile failed:",a),alert("Gagal memuat profil: "+a.message)}}),document.querySelectorAll(".modal-close-btn").forEach(a=>{a.addEventListener("click",s=>{s.target.closest(".modal-backdrop").classList.add("hidden")})}),document.querySelectorAll(".modal-backdrop").forEach(a=>{a.addEventListener("click",s=>{s.target===a&&a.classList.add("hidden")})})}function Y(){const e=document.getElementById("form-profile");e&&e.addEventListener("submit",async n=>{n.preventDefault();const a=document.getElementById("profile-name").value,s=document.getElementById("profile-email").value,o=document.getElementById("profile-phone").value,r=document.getElementById("profile-current-password").value,t=document.getElementById("profile-new-password").value;try{const l={name:a,email:s,phone:o};t&&r&&(l.currentPassword=r,l.newPassword=t);const i=await fetch(`${h}/auth/profile`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(l)});if(i.ok)alert("Profil berhasil diperbarui"),document.getElementById("profile-current-password").value="",document.getElementById("profile-new-password").value="",document.getElementById("modal-profile").classList.add("hidden");else{const c=await i.json();alert(c.message||"Gagal memperbarui profil")}}catch(l){console.error("Update profile failed:",l),alert("Terjadi kesalahan saat memperbarui profil")}}),V()}function V(){const e=document.getElementById("form-user");if(!e)return;const n=document.getElementById("btn-add-user");n&&n.addEventListener("click",()=>{e.reset(),document.getElementById("user-id").value="",document.getElementById("generated-password-display").classList.add("hidden"),document.getElementById("user-form-title").textContent="Tambah Admin",document.getElementById("user-admin-umum").checked=!0,document.getElementById("user-managed-assets-wrapper").classList.add("hidden"),document.getElementById("modal-user-form").classList.remove("hidden")}),e.addEventListener("submit",async a=>{a.preventDefault();const s=document.getElementById("user-id").value,o={username:document.getElementById("user-username").value.trim(),name:document.getElementById("user-name").value.trim(),email:document.getElementById("user-email").value.trim(),phone:document.getElementById("user-phone").value.trim(),adminType:document.querySelector('input[name="user-admin-type"]:checked')?.value||"umum",managedAssetCodes:[]};if(o.adminType==="khusus"){const r=document.querySelectorAll('input[name="managed-asset"]:checked');o.managedAssetCodes=Array.from(r).map(t=>t.value)}if(!o.username||!o.name||!o.email){alert("Username, name, dan email wajib diisi");return}try{const r=s?"PUT":"POST",t=s?`${h}/auth/admin/${s}`:`${h}/auth/admin`,l=await fetch(t,{method:r,headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(o)});if(!l.ok){const c=await l.json();throw new Error(c.message||"Gagal menyimpan admin")}const i=await l.json();!s&&i.generatedPassword?(document.getElementById("generated-password-text").textContent=i.generatedPassword,document.getElementById("generated-password-display").classList.remove("hidden"),document.getElementById("copy-password-btn").addEventListener("click",()=>{navigator.clipboard.writeText(i.generatedPassword),alert("Password berhasil disalin")})):(alert(`Admin berhasil ${s?"diperbarui":"dibuat"}`),document.getElementById("modal-user-form").classList.add("hidden"),C())}catch(r){alert(`Gagal: ${r.message}`)}})}async function C(){try{const a=(await(await fetch(`${h}/auth/admins`,{credentials:"include"})).json()).admins||[],s=document.getElementById("users-list-table");if(!s)return;if(a.length===0){s.innerHTML='<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada admin.</td></tr>';return}s.innerHTML=a.map(o=>`
            <tr class="table-row" data-admin-id="${o._id}">
                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700 font-mono">${o.username}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${o.name}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">${o.email}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">${o.phone||"-"}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${o.isActive?"bg-green-50 text-green-700":"bg-red-50 text-red-700"}">
                        ${o.isActive?"Aktif":"Nonaktif"}
                    </span>
                </td>
                <td class="px-6 py-3 text-right text-sm">
                    <div class="flex justify-end gap-3">
                        <button class="btn-edit" data-id="${o._id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${o._id}" title="Hapus"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>
        `).join("")}catch(e){console.error("Gagal memuat admin:",e)}}function W(){const e=document.getElementById("users-list-table");e&&e.addEventListener("click",async n=>{const a=n.target.closest(".btn-edit"),s=n.target.closest(".btn-delete");if(n.target.closest("tr[data-admin-id]")){if(a){const r=a.dataset.id;try{const l=await(await fetch(`${h}/auth/admin/${r}`,{credentials:"include"})).json(),i=l.admin||l;document.getElementById("user-id").value=i._id,document.getElementById("user-username").value=i.username,document.getElementById("user-name").value=i.name,document.getElementById("user-email").value=i.email,document.getElementById("user-phone").value=i.phone||"";const c=i.adminType||"umum";if(document.getElementById("user-admin-umum").checked=c==="umum",document.getElementById("user-admin-khusus").checked=c==="khusus",c==="khusus"){document.getElementById("user-managed-assets-wrapper").classList.remove("hidden");const d=await(await fetch(`${h}/api/assets`,{credentials:"include"})).json(),m=[...d.gedung||[],...d.kendaraan||[],...d.barang||[]],g=document.getElementById("user-managed-assets");g&&(g.innerHTML=m.map(p=>{const f=(i.managedAssetCodes||[]).includes(p.code);return`
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" value="${p.code}" name="managed-asset" ${f?"checked":""}>
                                    <span>${p.code} - ${p.name}</span>
                                </label>
                            `}).join(""))}else document.getElementById("user-managed-assets-wrapper").classList.add("hidden");document.getElementById("user-form-title").textContent="Edit Admin",document.getElementById("generated-password-display").classList.add("hidden"),document.getElementById("modal-user-form").classList.remove("hidden")}catch(t){alert("Gagal memuat data admin: "+t.message)}}else if(s){const r=s.dataset.id;if(confirm("Hapus admin ini?"))try{const t=await fetch(`${h}/auth/admin/${r}`,{method:"DELETE",credentials:"include"});if(t.ok)alert("Admin berhasil dihapus"),C();else{const l=await t.json();alert("Gagal menghapus: "+(l.message||"Error"))}}catch(t){alert("Gagal menghapus admin: "+t.message)}}}})}function X(){const e=document.querySelectorAll('input[name="user-admin-type"]'),n=document.getElementById("user-managed-assets-wrapper");e.forEach(a=>{a.addEventListener("change",async s=>{if(s.target.value==="khusus"){n?.classList.remove("hidden");try{const r=await(await fetch(`${h}/api/assets`,{credentials:"include"})).json(),t=[...r.gedung||[],...r.kendaraan||[],...r.barang||[]],l=document.getElementById("user-managed-assets");l&&t&&t.length>0&&(l.innerHTML=t.map(i=>`
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" value="${i.code}" name="managed-asset">
                                <span>${i.code} - ${i.name}</span>
                            </label>
                        `).join(""))}catch(o){console.error("Gagal memuat aset:",o)}}else n?.classList.add("hidden")})})}function Z(){fetch(`${h}/auth/me`,{credentials:"include"}).then(e=>e.json()).then(e=>{e.role==="superadmin"&&(C(),W())}).catch(e=>console.error("Error loading admin data:",e))}function ee(){const e=document.querySelectorAll(".tab-btn");e.forEach(n=>{n.addEventListener("click",a=>{const s=n.id.replace("admin-tab-","");e.forEach(r=>r.classList.remove("active")),n.classList.add("active"),document.querySelectorAll('[id^="admin-content-"]').forEach(r=>{r.classList.add("hidden")});const o=document.getElementById(`admin-content-${s}`);o&&o.classList.remove("hidden")})})}function L(e){try{const n=new Date(e);return isNaN(n.getTime())?"":n.toISOString().split("T")[0]}catch(n){return console.error("Error formatting date:",e,n),""}}function k(){return window.__adminState||null}const b={fetch:async function(e,n={}){try{const a=await fetch(e,{...n,credentials:"include"}),o=a.headers.get("content-type")?.includes("application/json")?await a.json():await a.text();if(!a.ok)throw new Error(o.message||`HTTP ${a.status}`);return o}catch(a){throw console.error("API Error:",a),new Error(a.message||"Operasi gagal")}},fetchAssets:()=>b.fetch("/api/assets",{cache:"no-store"}),fetchDrivers:()=>b.fetch("/api/drivers",{cache:"no-store"}),fetchAllBookings:()=>b.fetch("/api/bookings"),fetchAllRequests:()=>b.fetch("/api/requests"),approveRequest:(e,n,a)=>b.fetch(`/api/requests/${e}/approve`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({approvedBy:n,driver:a})}),rejectRequest:(e,n)=>b.fetch(`/api/requests/${e}/reject`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({rejectionReason:n})})};function H(){const e=document.querySelectorAll("th.sortable");if(!e.length)return;const n={column:null,direction:"asc"};e.forEach(a=>{const s=a.cloneNode(!0);a.parentNode.replaceChild(s,a),s.addEventListener("click",function(){const o=this.getAttribute("data-sort"),r=this.closest("table").querySelector("tbody").id;if(document.querySelectorAll("th.sortable").forEach(t=>{const l=t.querySelector(".sort-icon");l&&(l.innerHTML='<i class="fa fa-sort"></i>'),t.classList.remove("sort-asc","sort-desc")}),n.column===o?n.direction=n.direction==="asc"?"desc":"asc":(n.column=o,n.direction="asc"),n.direction==="asc"){this.classList.add("sort-asc");const t=this.querySelector(".sort-icon");t&&(t.innerHTML='<i class="fa fa-sort-up"></i>')}else{this.classList.add("sort-desc");const t=this.querySelector(".sort-icon");t&&(t.innerHTML='<i class="fa fa-sort-down"></i>')}te(r,o,n.direction)})})}function te(e,n,a){const s=document.getElementById(e);if(!s)return;const o=Array.from(s.querySelectorAll("tr"));if(o.length===0)return;const r=o.sort((t,l)=>{let i,c;switch(n){case"created":{i=T(t.cells[0].textContent.trim()),c=T(l.cells[0].textContent.trim());break}case"type":{const d=e==="master-asset-table"?2:1;i=t.cells[d].textContent.trim().toLowerCase(),c=l.cells[d].textContent.trim().toLowerCase();break}case"aset":{const d=e==="request-list-table"?2:1;i=t.cells[d].textContent.trim().toLowerCase(),c=l.cells[d].textContent.trim().toLowerCase();break}case"peminjam":case"pemakai":{const d=e==="request-list-table"?3:2;i=t.cells[d].textContent.trim().toLowerCase(),c=l.cells[d].textContent.trim().toLowerCase();break}case"tanggal":{const d=e==="request-list-table"?4:3;i=T(t.cells[d].textContent.trim()),c=T(l.cells[d].textContent.trim());break}case"status":{if(e!=="request-list-table"){i="",c="";break}i=t.cells[5].textContent.trim().toLowerCase(),c=l.cells[5].textContent.trim().toLowerCase();break}case"gedung":case"kendaraan":{i=t.cells[1].textContent.trim().toLowerCase(),c=l.cells[1].textContent.trim().toLowerCase();break}case"barang":{i=t.cells[4].textContent.trim().toLowerCase(),c=l.cells[4].textContent.trim().toLowerCase();break}case"supir":{i=t.cells[4].textContent.trim().toLowerCase(),c=l.cells[4].textContent.trim().toLowerCase();break}case"keterangan":{i=t.cells[5].textContent.trim().toLowerCase(),c=l.cells[5].textContent.trim().toLowerCase();break}case"code":{i=t.cells[0].textContent.trim().toLowerCase(),c=l.cells[0].textContent.trim().toLowerCase();break}case"name":{i=t.cells[1].textContent.trim().toLowerCase(),c=l.cells[1].textContent.trim().toLowerCase();break}case"no-telp":{i=t.cells[2].textContent.trim().toLowerCase(),c=l.cells[2].textContent.trim().toLowerCase();break}case"qty":{i=parseInt(t.cells[3].textContent.trim())||0,c=parseInt(l.cells[3].textContent.trim())||0;break}case"detail":{const d=e==="driver-list-table"?3:4;i=t.cells[d].textContent.trim().toLowerCase(),c=l.cells[d].textContent.trim().toLowerCase();break}default:i="",c=""}let u=0;return i instanceof Date&&c instanceof Date||typeof i=="number"&&typeof c=="number"?u=i-c:u=String(i).localeCompare(String(c),"id"),a==="asc"?u:-u});for(;s.firstChild;)s.removeChild(s.firstChild);r.forEach(t=>s.appendChild(t))}function T(e){try{if(e.includes("-")&&(e=e.split("-")[0].trim()),/\d{1,2}\/\d{1,2}\/\d{4}/.test(e)){const[o,r,t]=e.split("/").map(Number);return new Date(t,r-1,o)}if(/\d{1,2}-\d{1,2}-\d{4}/.test(e)){const[o,r,t]=e.split("-").map(Number);return new Date(t,r-1,o)}const n=e.split(" "),a={Januari:0,Februari:1,Maret:2,April:3,Mei:4,Juni:5,Juli:6,Agustus:7,September:8,Oktober:9,November:10,Desember:11};if(n.length>=3){const o=parseInt(n[0],10),r=a[n[1]],t=parseInt(n[2],10);if(!isNaN(o)&&r!==void 0&&!isNaN(t))return new Date(t,r,o)}const s=new Date(e);return isNaN(s.getTime())?e:s}catch(n){return console.error("Error parsing date:",n),e}}const v={renderBookingList:function(e,n){const a=`${e}-list-table`,s=document.getElementById(a);if(!s){console.warn(`âŒ Table element not found for type: ${e}`);return}console.log(`ðŸ“Š Rendering ${e} table with ${n.length} bookings`),s.innerHTML="";const o=[...n].sort((t,l)=>new Date(l.startDate)-new Date(t.startDate));if(o.length===0){s.innerHTML='<tr><td colspan="7" class="text-center py-4 text-gray-500">Tidak ada data untuk filter ini.</td></tr>';return}const r="px-6 py-3 whitespace-nowrap text-sm text-gray-500";s.innerHTML=o.map(t=>{const l=new Date(t.startDate),i=new Date(t.endDate);let c=l.toLocaleDateString("id-ID");l.toDateString()!==i.toDateString()&&(c+=` - ${i.toLocaleDateString("id-ID")}`);const u=t.createdAt?new Date(t.createdAt).toLocaleDateString("id-ID"):"-";if(e==="gedung"){const d=ne(t.borrowedItems);return`<tr class="table-row cursor-pointer" data-booking-id="${t._id}">
                    <td class="${r}">${u}</td>
                    <td class="${r} font-medium text-gray-900">${t.assetName}</td>
                    <td class="${r}">${t.userName}</td>
                    <td class="${r}">${c}</td>
                    <td class="${r}">${d}</td>
                    <td class="${r}">${t.notes||"-"}</td>
                    <td class="${r} text-right">
                        <button type="button" class="mr-2"><i class="fas fa-pen-to-square text-emerald-700 hover:text-emerald-800 btn btn-edit" data-id="${t._id}"></i></button>
                        <button type="button"><i class="fas fa-trash color-gedung hover:opacity-80 btn btn-delete" data-id="${t._id}"></i></button>
                    </td>
                </tr>`}else{const d=typeof t.driver=="object"&&t.driver?t.driver.name:t.driver||"-";return`<tr class="table-row cursor-pointer" data-booking-id="${t._id}">
                    <td class="${r}">${u}</td>
                    <td class="${r} font-medium text-gray-900">${t.assetName}</td>
                    <td class="${r}">${t.userName}</td>
                    <td class="${r}">${c}</td>
                    <td class="${r}">${d}</td>
                    <td class="${r}">${t.notes||"-"}</td>
                    <td class="${r} text-right">
                        <button type="button" class="mr-2"><i class="fas fa-pen-to-square text-emerald-700 hover:text-emerald-800 btn btn-edit" data-id="${t._id}"></i></button>
                        <button type="button"><i class="fas fa-trash color-gedung hover:opacity-80 btn btn-delete" data-id="${t._id}"></i></button>
                    </td>
                </tr>`}}).join(""),H()},renderRequestList:function(e){const n=document.getElementById("request-list-table");if(!n)return;n.innerHTML="";const a=[...e].sort((s,o)=>new Date(o.createdAt)-new Date(s.createdAt));if(a.length===0){n.innerHTML='<tr><td colspan="7" class="px-6 py-3 text-center text-gray-500">Tidak ada data</td></tr>';return}n.innerHTML=a.map(s=>{const o=s.createdAt?new Date(s.createdAt).toLocaleDateString("id-ID"):"-",r=new Date(s.startDate).toLocaleDateString("id-ID"),t="px-6 py-3 whitespace-nowrap text-sm text-gray-500",l=s.status==="pending"?"bg-yellow-100 text-yellow-800":s.status==="approved"?"bg-green-100 text-green-800":"bg-red-100 text-red-800",i=s.status==="pending"?"Pending":s.status==="approved"?"Diterima":"Ditolak";return`<tr class="table-row cursor-pointer hover:bg-gray-100" data-request-id="${s._id}">
                <td class="${t}">${o}</td>
                <td class="${t}">${s.bookingType==="gedung"?"Gedung":"Kendaraan"}</td>
                <td class="${t}">${s.assetName||"-"}</td>
                <td class="${t}">${s.userName||"-"}</td>
                <td class="${t}">${r}</td>
                <td class="${t}"><span class="px-2 py-1 rounded text-xs font-semibold ${l}">${i}</span></td>
                <td class="${t}"><span class="text-xs text-gray-700">${s.requestId||s._id}</span></td>
            </tr>`}).join("")},renderDriverList:function(e){const n=document.getElementById("driver-list-table");if(!n)return;n.innerHTML="";const a=[...e].sort((s,o)=>(s.code||"").localeCompare(o.code||""));if(a.length===0){n.innerHTML='<tr><td colspan="6" class="px-6 py-3 text-center text-gray-500">Tidak ada data</td></tr>';return}n.innerHTML=a.map(s=>{const o="px-6 py-3 whitespace-nowrap text-sm text-gray-500",r=s.status==="aktif"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600",t=s.status==="aktif"?"Aktif":"Tidak Aktif";return`<tr class="cursor-pointer" data-driver-id="${s._id}">
                <td class="${o}">${s.code||"-"}</td>
                <td class="${o}">${s.name||"-"}</td>
                <td class="${o}">${s.noTelp||"-"}</td>
                <td class="${o}">${s.detail||"-"}</td>
                <td class="${o}">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${r}">${t}</span>
                </td>
                <td class="px-6 py-3 text-right text-sm">
                    <div class="flex justify-end gap-3">
                        <button class="btn-edit" data-id="${s._id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${s._id}" title="Hapus"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`}).join("")},renderMasterTable:function(e){const n=document.getElementById("master-asset-table");if(!n)return;n.innerHTML="";const a=[...e].sort((s,o)=>s.name.localeCompare(o.name));if(a.length===0){n.innerHTML='<tr><td colspan="6" class="px-6 py-3 text-center text-gray-500">Tidak ada data</td></tr>';return}n.innerHTML=a.map(s=>{const o="px-6 py-3 whitespace-nowrap text-sm text-gray-500";return`<tr class="cursor-pointer" data-asset-id="${s._id}">
                <td class="${o}">${s.code||"-"}</td>
                <td class="${o}">${s.name||"-"}</td>
                <td class="${o}"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700">${s.type||"-"}</span></td>
                <td class="${o}">${s.num??"-"}</td>
                <td class="${o}">${s.detail||"-"}</td>
                <td class="px-6 py-3 text-right text-sm">
                    <div class="flex justify-end gap-3">
                        <button class="btn-edit" data-id="${s._id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${s._id}" title="Hapus"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`}).join("")},showDetailModal:function(e,n="admin",a){let s=e.assetName;if(e.bookingType==="kendaraan"&&a.assets&&a.assets.kendaraan){const d=a.assets.kendaraan.find(g=>g.name===e.assetName),m=d&&d.code?d.code:"";s=m?`${e.assetName} (${m})`:e.assetName}const o=document.getElementById("modal-title"),r=document.getElementById("modal-body"),t=document.getElementById("modal-detail-event");if(!o||!r||!t){console.error("Modal elements not found");return}o.innerText=`${s}`;const l=new Date(e.startDate),i=new Date(e.endDate);let u=`<p>${ae(l,i,v)}</p>`;if(e.bookingId&&(u+=`<p><strong>Booking ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.bookingId}</code></p>`),u+=`<p><strong>Peminjam:</strong> ${e.userName}</p>`,n==="admin"){if(e.personInCharge&&(u+=`<p><strong>Penanggung Jawab:</strong> ${e.personInCharge}</p>`),e.picPhoneNumber&&(u+=`<p><strong>No. Telepon:</strong> ${e.picPhoneNumber}</p>`),e.bookingType==="gedung")e.activityName&&(u+=`<p><strong>Kegiatan:</strong> ${e.activityName}</p>`),e.borrowedItems&&e.borrowedItems.length>0&&(u+='<p><strong>Barang Dipinjam:</strong></p><ul class="ml-4 list-disc">',e.borrowedItems.forEach(d=>{u+=`<li>${d.assetName} (${d.assetCode}) - ${d.quantity} unit</li>`}),u+="</ul>");else if(e.bookingType==="kendaraan"&&(e.destination&&(u+=`<p><strong>Tujuan:</strong> ${e.destination}</p>`),e.driver&&(typeof e.driver=="object"?e.driver.name:e.driver))){const d=typeof e.driver=="object"?e.driver.name:e.driver;u+=`<p><strong>Supir:</strong> ${d}</p>`}e.notes&&(u+=`<p><strong>Keterangan:</strong> ${e.notes}</p>`),e.letterFile&&(u+=`
                    <div style="margin-top: 12px; padding: 12px; background-color: #f3f4f6; border-radius: 6px;">
                        <p style="margin: 0 0 8px 0; font-weight: 600; font-size: 14px;">ðŸ“„ Surat Permohonan</p>
                        <a href="/uploads/${e.letterFile}" 
                           target="_blank" 
                           style="display: inline-block; padding: 8px 12px; background-color: #3b82f6; color: white; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-eye"></i> Lihat Surat
                        </a>
                    </div>
                `)}r.innerHTML=u,t.classList.remove("hidden")},formatDateShort:e=>{const n=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Ags","Sep","Okt","Nov","Des"],a=String(e.getDate()).padStart(2,"0"),s=n[e.getMonth()],o=e.getFullYear();return`${a} ${s} ${o}`},formatTimeDot:e=>{const n=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0");return`${n}.${a}`}};function ne(e){return e?Array.isArray(e)&&e.length?e.map(n=>`${n.assetName}: ${n.quantity}`).join(", "):typeof e=="string"&&e.trim()?e:"-":"-"}function ae(e,n,a){const s=e.toDateString()===n.toDateString(),o=a.formatDateShort(e),r=a.formatTimeDot(e),t=a.formatDateShort(n),l=a.formatTimeDot(n);return s?`${o}, ${r}-${l} WIB`:`${o}, ${r} WIB - ${t}, ${l} WIB`}function se(e){const n=document.getElementById("filter-gedung-asset");n&&e.assets&&e.assets.gedung&&(n.innerHTML='<option value="all">Semua Gedung</option>',e.assets.gedung.forEach(r=>{n.innerHTML+=`<option value="${r.code}">${r.name}</option>`}),console.log("âœ… Populated gedung assets:",e.assets.gedung.length));const a=document.getElementById("filter-gedung-barang");a&&e.assets&&e.assets.barang&&(a.innerHTML='<option value="all">Semua Barang</option>',e.assets.barang.forEach(r=>{a.innerHTML+=`<option value="${r.code}">${r.name}</option>`}),console.log("âœ… Populated barang:",e.assets.barang.length));const s=document.getElementById("filter-kendaraan-asset");s&&e.assets&&e.assets.kendaraan&&(s.innerHTML='<option value="all">Semua Kendaraan</option>',e.assets.kendaraan.forEach(r=>{s.innerHTML+=`<option value="${r.code}">${r.name}</option>`}),console.log("âœ… Populated kendaraan assets:",e.assets.kendaraan.length));const o=document.getElementById("filter-kendaraan-driver");if(o&&e.allDrivers&&e.allDrivers.length>0){const r=e.allDrivers.filter(t=>t.status==="aktif");o.innerHTML='<option value="all">Semua Supir</option>',r.forEach(t=>{o.innerHTML+=`<option value="${t._id}">${t.name}</option>`}),console.log("âœ… Populated drivers:",r.length)}else console.log("âŒ Could not populate drivers")}function oe(){const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`,a=document.getElementById("filter-request-status");a&&(a.value="pending");const s=document.getElementById("filter-gedung-month");s&&(s.value=n);const o=document.getElementById("filter-kendaraan-month");o&&(o.value=n)}function re(e,n){const a=document.getElementById("filters-gedung"),s=document.getElementById("filters-kendaraan"),o=document.getElementById("filters-request");if(a){a.addEventListener("input",()=>e("gedung")),a.addEventListener("change",()=>e("gedung"));const r=document.getElementById("filter-gedung-search");r&&r.addEventListener("keyup",()=>e("gedung"))}if(s){s.addEventListener("input",()=>e("kendaraan")),s.addEventListener("change",()=>e("kendaraan"));const r=document.getElementById("filter-kendaraan-search");r&&r.addEventListener("keyup",()=>e("kendaraan"))}o&&(o.addEventListener("input",()=>n()),o.addEventListener("change",()=>n()))}function S(e,n,a){console.log(`ðŸ” applyAdminFilters called for type: ${e}`);const s=document.getElementById(`filters-${e}`);if(!s){console.warn(`âš ï¸  Filter panel not found for type: ${e}`);return}const o=s.querySelector(`#filter-${e}-month`),r=s.querySelector(`#filter-${e}-asset`),t=e==="gedung"?s.querySelector("#filter-gedung-barang"):null,l=s.querySelector(`#filter-${e}-search`),i=e==="kendaraan"?s.querySelector(`#filter-${e}-driver`):null,c=o?o.value:"",u=r?r.value:"all",d=t?t.value:"all",m=l?l.value.trim().toLowerCase():"",g=i?i.value:"all";console.log(`ðŸ“‹ Filter values - month: ${c}, asset: ${u}, barang: ${d}, driver: ${g}, search: ${m}`),console.log(`ðŸ“¦ state.allBookingsCache has ${n.allBookingsCache.length} items`);const p=a(n.allBookingsCache,{type:e,month:c,asset:u,barang:d,driver:g,searchQuery:m});console.log(`ðŸŽ¯ Filtered to ${p.length} bookings, rendering...`),v.renderBookingList(e,p)}function j(e,n){return e.filter(a=>{if(a.bookingType!==n.type)return!1;if(n.month){const s=new Date(a.startDate),o=s.getFullYear(),r=String(s.getMonth()+1).padStart(2,"0");if(`${o}-${r}`!==n.month)return!1}if(n.asset&&n.asset!=="all"&&a.assetCode!==n.asset||n.barang&&n.barang!=="all"&&!(Array.isArray(a.borrowedItems)&&a.borrowedItems.some(o=>o.assetCode===n.barang)))return!1;if(n.driver&&n.driver!=="all"){const s=typeof a.driver=="object"&&a.driver?a.driver._id:a.driver;if(!s||s!==n.driver)return!1}if(n.searchQuery){const s=a.assetName&&a.assetName.toLowerCase().includes(n.searchQuery),o=a.userName&&a.userName.toLowerCase().includes(n.searchQuery),r=a.notes&&a.notes.toLowerCase().includes(n.searchQuery);let t=!1;if(a.bookingType==="gedung"&&Array.isArray(a.borrowedItems)&&a.borrowedItems.map(i=>`${i.assetName} ${i.assetCode}`).join(" ").toLowerCase().includes(n.searchQuery)&&(t=!0),a.bookingType==="kendaraan"&&((typeof a.driver=="object"&&a.driver?a.driver.name:a.driver||"").toLowerCase().includes(n.searchQuery)&&(t=!0),a.destination&&a.destination.toLowerCase().includes(n.searchQuery)&&(t=!0)),!(s||o||r||t))return!1}return!0})}function A(e){console.log("ðŸ” applyRequestFilters called");const n=document.getElementById("filters-request");if(!n){console.warn("âš ï¸  Request filter panel not found");return}const a=n.querySelector("#filter-request-type"),s=n.querySelector("#filter-request-status"),o=n.querySelector("#filter-request-month"),r=n.querySelector("#filter-request-search"),t=a?a.value:"all",l=s?s.value:"all",i=o?o.value:"",c=r?r.value.trim().toLowerCase():"",u=e.allRequestsCache.filter(d=>{if(t!=="all"&&d.bookingType!==t||l!=="all"&&d.status!==l)return!1;if(i){const m=new Date(d.startDate),g=m.getFullYear(),p=String(m.getMonth()+1).padStart(2,"0");if(`${g}-${p}`!==i)return!1}if(c){const m=d.assetName?.toLowerCase().includes(c),g=d.userName?.toLowerCase().includes(c),p=d.notes?d.notes.toLowerCase().includes(c):!1,f=d.requestId?d.requestId.toLowerCase().includes(c):!1,E=d._id?String(d._id).toLowerCase().includes(c):!1;if(!(m||g||p||f||E))return!1}return!0});v.renderRequestList(u)}function ie(e,n){const a=document.getElementById("filter-driver-search");a&&(a.addEventListener("input",e),a.addEventListener("keyup",e));const s=document.getElementById("master-filter-type"),o=document.getElementById("master-search");s&&s.addEventListener("change",n),o&&(o.addEventListener("input",n),o.addEventListener("keyup",n))}function F(e){const n=document.getElementById("filter-driver-search"),a=n?n.value.trim().toLowerCase():"",s=Array.isArray(e.allDrivers)?e.allDrivers:[],o=a?s.filter(r=>[r.code,r.name,r.noTelp,r.detail].map(l=>(l||"").toString().toLowerCase()).some(l=>l.includes(a))):s;v.renderDriverList(o)}function G(e){const n=document.getElementById("master-filter-type"),a=document.getElementById("master-search"),s=n?n.value:"all",o=a?a.value.trim().toLowerCase():"";let r=Array.isArray(e.allAssetsCache)?[...e.allAssetsCache]:[];s&&s!=="all"&&(r=r.filter(t=>t.type===s)),o&&(r=r.filter(t=>[t.code,t.name,t.detail].map(i=>(i||"").toString().toLowerCase()).some(i=>i.includes(o)))),v.renderMasterTable(r)}function $(e=null){const n=k(),a=document.getElementById("gedung-barang-select");if(!n||!a)return;const s=Array.isArray(n.assets?.barang)?n.assets.barang:[],o=a.value;a.innerHTML="",s.forEach(r=>{const t=e?e.get(r.code)??0:Number(r.num||0),l=document.createElement("option");l.value=r.code,l.textContent=`${r.name} (${r.code})${Number.isFinite(t)?` - tersisa ${t}`:""}`,l.disabled=t<=0,a.appendChild(l)}),o&&(a.value=o)}function q(e){if(!e)return;e.__barangItems=new Map;const n=e.querySelector("#gedung-barang-chips");n&&(n.innerHTML=""),$(),I(e,null)}function R(e,n,a,s){if(!e)return;e.__barangItems||(e.__barangItems=new Map),e.__barangItems.set(n,{assetCode:n,assetName:a,quantity:s});const o=e.querySelector("#gedung-barang-chips");if(!o)return;const r=document.createElement("span");r.className="inline-flex items-center bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full",r.dataset.code=n,r.innerHTML=`
        <span class="mr-1 font-semibold">${a}: ${s}</span>
        <button type="button" class="ml-1 text-emerald-800 hover:text-red-600" title="Hapus">&times;</button>
    `,o.querySelectorAll("span[data-code]").forEach(t=>{t.dataset.code===n&&t.remove()}),o.appendChild(r),r.querySelector("button")?.addEventListener("click",()=>{e.__barangItems.delete(n),r.remove(),w(e)})}function de(e,n,a=null){const s=k();if(!s||!e||!n)return new Map;const o=new Map;s.allBookingsCache.forEach(t=>{if(a&&t._id===a)return;const l=new Date(t.startDate),i=new Date(t.endDate);e<i&&n>l&&Array.isArray(t.borrowedItems)&&t.borrowedItems.forEach(c=>{const u=c.assetCode,d=Number(c.quantity||0);!u||!Number.isFinite(d)||d<=0||o.set(u,(o.get(u)||0)+d)})});const r=new Map;return(s.assets?.barang||[]).forEach(t=>{const l=Number(t.num||0),i=o.get(t.code)||0;r.set(t.code,Math.max(0,l-i))}),r}function I(e,n){const a=e?.querySelector("#gedung-barang-select"),s=e?.querySelector("#gedung-barang-qty");if(!a||!s)return;const o=a.value||null;let r=0;if(n&&o&&(r=n.get(o)??0),r<0&&(r=0),s.max=String(r),s.placeholder=r>0?`Qty (maks: ${r})`:"Qty",s.value){const t=Number(s.value);Number.isFinite(t)&&t>r&&(s.value=r||"")}s.disabled=r===0}function w(e){if(!k()||!e)return;const a=e.querySelector("#gedung-use-time")?.checked,s=e.querySelector("#gedung-mulai-tanggal"),o=e.querySelector("#gedung-selesai-tanggal"),r=e.querySelector("#gedung-mulai-jam"),t=e.querySelector("#gedung-selesai-jam"),l=e.querySelector("#gedung-booking-id")?.value||null;if(!s||!o)return;let i,c;if(a){if(!s.value||!o.value||!r?.value||!t?.value){$(),e.__barangAvailability=null,I(e,null);return}i=new Date(`${s.value}T${r.value}`),c=new Date(`${o.value}T${t.value}`)}else{if(!s.value||!o.value){$(),e.__barangAvailability=null,I(e,null);return}i=new Date(s.value),c=new Date(o.value),c.setHours(23,59,59,999)}if(isNaN(i)||isNaN(c)||i>=c){$(),e.__barangAvailability=null,I(e,null);return}const u=de(i,c,l);(e.__barangItems?[...e.__barangItems.values()]:[]).forEach(m=>{const g=u.get(m.assetCode)??0;u.set(m.assetCode,Math.max(0,g-Number(m.quantity||0)))}),e.__barangAvailability=u,$(u),I(e,u)}function le(e,n){e&&(q(e),n?.borrowedItems&&Array.isArray(n.borrowedItems)&&n.borrowedItems.forEach(a=>{R(e,a.assetCode,a.assetName,a.quantity)}),w(e))}function ce(){const e=document.getElementById("form-gedung");if(!e)return;const n=e.querySelector("#gedung-use-time"),a=e.querySelector("#gedung-time-inputs"),s=e.querySelector("#gedung-mulai-tanggal"),o=e.querySelector("#gedung-selesai-tanggal"),r=e.querySelector("#gedung-mulai-jam"),t=e.querySelector("#gedung-selesai-jam"),l=e.querySelector("#gedung-barang-add"),i=e.querySelector("#gedung-barang-qty"),c=e.querySelector("#gedung-barang-select");q(e),n&&a&&n.addEventListener("change",()=>{a.classList.toggle("hidden",!n.checked),w(e)}),[s,o,r,t].forEach(u=>{u?.addEventListener("change",()=>w(e))}),c?.addEventListener("change",()=>I(e,e.__barangAvailability||null)),i?.addEventListener("input",()=>I(e,e.__barangAvailability||null)),l?.addEventListener("click",()=>{const u=k();if(!u)return alert("Data aset belum siap.");const d=c?.value,m=Number(i?.value),g=(u.assets?.barang||[]).find(E=>E.code===d);if(!g)return alert("Pilih barang.");if(!Number.isFinite(m)||m<=0)return alert("Masukkan qty valid.");const f=(e.__barangAvailability||new Map).get(d)??0;if(m>f)return alert(`Qty melebihi stok tersedia (${f}).`);R(e,g.code,g.name,m),i&&(i.value=""),w(e)}),w(e)}function N(e=null){const n=document.getElementById("modal-form-gedung"),a=document.getElementById("form-gedung"),s=document.getElementById("gedung-form-title");!n||!a||(s.textContent=e?"Edit Pinjam Gedung":"Form Pinjam Gedung",a.reset(),q(a),e?(document.getElementById("gedung-booking-id").value=e._id||"",document.getElementById("gedung-peminjam").value=e.userName||"",document.getElementById("gedung-name").value=e.assetCode||"",document.getElementById("gedung-penanggung-jawab").value=e.personInCharge||"",document.getElementById("gedung-nomor-penanggung-jawab").value=e.picPhoneNumber||"",document.getElementById("gedung-kegiatan").value=e.activityName||"",document.getElementById("gedung-keterangan").value=e.notes||"",document.getElementById("gedung-mulai-tanggal").value=L(e.startDate),document.getElementById("gedung-selesai-tanggal").value=L(e.endDate),le(a,e)):w(a),n.classList.remove("hidden"))}function M(e=null){const n=document.getElementById("modal-asset"),a=document.getElementById("form-asset"),s=document.getElementById("asset-form-title");if(!n||!a||!s){console.error("Asset modal elements not found");return}s.textContent=e?"Edit Aset":"Tambah Aset",a.reset();const o=document.getElementById("asset-id");if(o&&(o.value=""),e){const r=document.getElementById("asset-id"),t=document.getElementById("asset-code"),l=document.getElementById("asset-name"),i=document.getElementById("asset-type"),c=document.getElementById("asset-detail"),u=document.getElementById("asset-num");r&&(r.value=e._id||""),t&&(t.value=e.code||""),l&&(l.value=e.name||""),i&&(i.value=e.type||""),c&&(c.value=e.detail||""),u&&e.num!==void 0&&e.num!==null&&(u.value=e.num),D(e.type)}else D("gedung");n.classList.remove("hidden")}function D(e){const n=document.getElementById("asset-num-wrapper"),a=document.getElementById("asset-num");if(!n||!a)return;const s=e==="barang"||e==="kendaraan";n.classList.toggle("hidden",!s),a.placeholder=e==="barang"?"Qty (misal: 40)":"Max penumpang (misal: 15)"}function ue(){const e=document.getElementById("asset-type");e&&e.addEventListener("change",n=>{D(n.target.value)})}function P(e=null){const n=document.getElementById("modal-form-kendaraan"),a=document.getElementById("form-kendaraan"),s=document.getElementById("kendaraan-form-title");!n||!a||(s.textContent=e?"Edit Pinjam Kendaraan":"Form Pinjam Kendaraan",a.reset(),e&&(document.getElementById("kendaraan-booking-id").value=e._id||"",document.getElementById("kendaraan-peminjam").value=e.userName||"",document.getElementById("kendaraan-name").value=e.assetCode||"",document.getElementById("kendaraan-penanggung-jawab").value=e.personInCharge||"",document.getElementById("kendaraan-nomor-penanggung-jawab").value=e.picPhoneNumber||"",document.getElementById("kendaraan-tujuan").value=e.destination||"",document.getElementById("kendaraan-keterangan").value=e.notes||"",document.getElementById("kendaraan-mulai-tanggal").value=L(e.startDate),document.getElementById("kendaraan-selesai-tanggal").value=L(e.endDate),e.driver&&(document.getElementById("kendaraan-supir").value=typeof e.driver=="object"?e.driver._id:e.driver)),n.classList.remove("hidden"))}function _(e=null){const n=document.getElementById("modal-form-driver"),a=document.getElementById("form-driver"),s=document.getElementById("driver-form-title");if(!n||!a||!s){console.error("Driver modal elements not found");return}s.textContent=e?"Edit Supir":"Tambah Supir",a.reset();const o=document.getElementById("driver-id");if(o&&(o.value=""),e){const r=document.getElementById("driver-id"),t=document.getElementById("driver-code"),l=document.getElementById("driver-name"),i=document.getElementById("driver-no-telp"),c=document.getElementById("driver-detail"),u=document.getElementById("driver-status");r&&(r.value=e._id||""),t&&(t.value=e.code||""),l&&(l.value=e.name||""),i&&(i.value=e.noTelp||""),c&&(c.value=e.detail||""),u&&(u.value=e.status||"aktif")}n.classList.remove("hidden")}const y=window.location.origin;function me(){const e=document.getElementById("form-gedung");e&&e.addEventListener("submit",async o=>{o.preventDefault();const r=document.getElementById("gedung-booking-id").value||null,t=document.getElementById("gedung-use-time").checked,l=document.getElementById("gedung-mulai-tanggal").value,i=document.getElementById("gedung-selesai-tanggal").value,c=document.getElementById("gedung-mulai-jam").value,u=document.getElementById("gedung-selesai-jam").value;let d,m;t&&l&&i&&c&&u?(d=new Date(`${l}T${c}`),m=new Date(`${i}T${u}`)):(d=l?new Date(l):null,m=i?new Date(i):null,m&&m.setHours(23,59,59,999));const g=document.getElementById("gedung-name").value,E=((window.__adminState||{}).assets?.gedung||[]).find(x=>x.code===g),Ie=E?E.name:g,B={bookingType:"gedung",userName:document.getElementById("gedung-peminjam").value,assetCode:g,assetName:Ie,personInCharge:document.getElementById("gedung-penanggung-jawab").value,picPhoneNumber:document.getElementById("gedung-nomor-penanggung-jawab").value,activityName:document.getElementById("gedung-kegiatan").value,notes:document.getElementById("gedung-keterangan").value,startDate:d,endDate:m,borrowedItems:Array.from(e.__barangItems?.values?.()||[])};if(!B.userName||!B.assetCode||!B.startDate||!B.endDate){alert("Nama peminjam, gedung, dan tanggal wajib diisi.");return}try{const x=r?"PUT":"POST",ke=r?`${y}/api/bookings/${r}`:`${y}/api/bookings`,K=await fetch(ke,{method:x,headers:{"Content-Type":"application/json"},body:JSON.stringify(B),credentials:"include"});if(!K.ok){const $e=await K.json();throw new Error($e.message||"Gagal menyimpan")}alert(`Peminjaman gedung berhasil ${r?"diperbarui":"ditambahkan"}.`),document.getElementById("modal-form-gedung").classList.add("hidden"),window.initializeApp?.()}catch(x){alert(`Gagal: ${x.message}`)}});const n=document.getElementById("form-kendaraan");n&&n.addEventListener("submit",async o=>{o.preventDefault();const r=document.getElementById("kendaraan-booking-id").value||null,t=document.getElementById("kendaraan-name").value,c=((window.__adminState||{}).assets?.kendaraan||[]).find(m=>m.code===t),u=c?c.name:t,d={bookingType:"kendaraan",userName:document.getElementById("kendaraan-peminjam").value,assetCode:t,assetName:u,personInCharge:document.getElementById("kendaraan-penanggung-jawab").value,picPhoneNumber:document.getElementById("kendaraan-nomor-penanggung-jawab").value,destination:document.getElementById("kendaraan-tujuan").value,notes:document.getElementById("kendaraan-keterangan").value,driver:document.getElementById("kendaraan-supir").value||null,startDate:new Date(document.getElementById("kendaraan-mulai-tanggal").value),endDate:new Date(document.getElementById("kendaraan-selesai-tanggal").value)};if(!d.userName||!d.assetCode){alert("Nama peminjam dan kendaraan wajib diisi.");return}try{const m=r?"PUT":"POST",g=r?`${y}/api/bookings/${r}`:`${y}/api/bookings`,p=await fetch(g,{method:m,headers:{"Content-Type":"application/json"},body:JSON.stringify(d),credentials:"include"});if(!p.ok){const f=await p.json();throw new Error(f.message||"Gagal menyimpan")}alert(`Peminjaman kendaraan berhasil ${r?"diperbarui":"ditambahkan"}.`),document.getElementById("modal-form-kendaraan").classList.add("hidden"),window.initializeApp?.()}catch(m){alert(`Gagal: ${m.message}`)}});const a=document.getElementById("form-driver");a&&a.addEventListener("submit",async o=>{o.preventDefault();const r=document.getElementById("driver-id").value||null,t={code:document.getElementById("driver-code").value.trim(),name:document.getElementById("driver-name").value.trim(),noTelp:document.getElementById("driver-no-telp").value.trim(),detail:document.getElementById("driver-detail").value.trim(),status:document.getElementById("driver-status").value||"aktif"};if(!t.code||!t.name){alert("Kode dan name supir wajib diisi.");return}try{const l=r?"PUT":"POST",i=r?`${y}/api/drivers/${r}`:`${y}/api/drivers`,c=await fetch(i,{method:l,headers:{"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"include"});if(!c.ok){const u=await c.json();throw new Error(u.message||"Gagal menyimpan")}alert(`Supir berhasil ${r?"diperbarui":"ditambahkan"}.`),document.getElementById("modal-form-driver").classList.add("hidden"),window.initializeApp?.()}catch(l){alert(`Gagal: ${l.message}`)}});const s=document.getElementById("form-asset");s&&s.addEventListener("submit",async o=>{o.preventDefault();const r=document.getElementById("asset-id").value||null,t={code:document.getElementById("asset-code").value.trim(),name:document.getElementById("asset-name").value.trim(),type:document.getElementById("asset-type").value,detail:document.getElementById("asset-detail").value.trim()},l=document.getElementById("asset-num").value;if(l!==""&&(t.num=Number(l)),!t.code||!t.name){alert("Kode dan name aset wajib diisi.");return}try{const i=r?"PUT":"POST",c=r?`${y}/api/assets/${r}`:`${y}/api/assets`,u=await fetch(c,{method:i,headers:{"Content-Type":"application/json"},body:JSON.stringify(t),credentials:"include"});if(!u.ok){const d=await u.json();throw new Error(d.message||"Gagal menyimpan")}alert(`Aset berhasil ${r?"diperbarui":"ditambahkan"}.`),document.getElementById("modal-asset").classList.add("hidden"),window.initializeApp?.()}catch(i){alert(`Gagal: ${i.message}`)}})}function ge(e){const n=document.getElementById("request-list-table");n&&n.addEventListener("click",t=>{const l=t.target.closest("tr[data-request-id]");if(!l)return;const c=e()?.allRequestsCache?.find(u=>u._id===l.dataset.requestId);c&&window.showRequestDetail&&window.showRequestDetail(c)});const a=document.getElementById("gedung-list-table");a&&a.addEventListener("click",async t=>{const l=t.target.closest(".btn-edit"),i=t.target.closest(".btn-delete"),c=t.target.closest("tr[data-booking-id]");if(c){if(l){const u=c.dataset.bookingId;try{const d=await fetch(`${y}/api/bookings/${u}`,{credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const m=await d.json();console.log("Booking data fetched:",m),N(m)}catch(d){console.error("Error loading booking:",d),alert("Gagal memuat data: "+d.message)}}else if(i){const u=c.dataset.bookingId;if(confirm("Hapus peminjaman ini?"))try{await fetch(`${y}/api/bookings/${u}`,{method:"DELETE",credentials:"include"}),alert("Peminjaman berhasil dihapus."),window.initializeApp?.()}catch(d){alert("Gagal menghapus: "+d.message)}}else if(!l&&!i){const d=e()?.allBookingsCache?.find(m=>m._id===c.dataset.bookingId);d&&window.showBookingDetail&&window.showBookingDetail(d,"admin")}}});const s=document.getElementById("kendaraan-list-table");s&&s.addEventListener("click",async t=>{const l=t.target.closest(".btn-edit"),i=t.target.closest(".btn-delete"),c=t.target.closest("tr[data-booking-id]");if(c){if(l){const u=c.dataset.bookingId;try{const d=await fetch(`${y}/api/bookings/${u}`,{credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const m=await d.json();console.log("Booking data fetched:",m),P(m)}catch(d){console.error("Error loading booking:",d),alert("Gagal memuat data: "+d.message)}}else if(i){const u=c.dataset.bookingId;if(confirm("Hapus peminjaman ini?"))try{await fetch(`${y}/api/bookings/${u}`,{method:"DELETE",credentials:"include"}),alert("Peminjaman berhasil dihapus."),window.initializeApp?.()}catch(d){alert("Gagal menghapus: "+d.message)}}else if(!l&&!i){const d=e()?.allBookingsCache?.find(m=>m._id===c.dataset.bookingId);d&&window.showBookingDetail&&window.showBookingDetail(d,"admin")}}});const o=document.getElementById("driver-list-table");o&&o.addEventListener("click",async t=>{const l=t.target.closest(".btn-edit"),i=t.target.closest(".btn-delete"),c=t.target.closest("tr[data-driver-id]");if(c){if(l){const u=l.dataset.id||c.dataset.driverId;try{const d=await fetch(`${y}/api/drivers/${u}`,{credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status}`);if(!d.headers.get("content-type")?.includes("application/json"))throw new Error("Server mengembalikan response yang bukan JSON");const g=await d.json();_(g)}catch(d){console.error("Error:",d),alert("Gagal memuat data supir: "+d.message)}}else if(i){const u=i.dataset.id||c.dataset.driverId;if(confirm("Hapus supir ini?"))try{const d=await fetch(`${y}/api/drivers/${u}`,{method:"DELETE",credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status}`);alert("Supir berhasil dihapus."),window.initializeApp?.()}catch(d){console.error("Error:",d),alert("Gagal menghapus: "+d.message)}}}});const r=document.getElementById("master-asset-table");r&&r.addEventListener("click",async t=>{const l=t.target.closest(".btn-edit"),i=t.target.closest(".btn-delete"),c=t.target.closest("tr[data-asset-id]");if(c){if(l){const u=l.dataset.id||c.dataset.assetId;try{const d=await fetch(`${y}/api/assets/${u}`,{credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status}`);if(!d.headers.get("content-type")?.includes("application/json"))throw new Error("Server mengembalikan response yang bukan JSON");const g=await d.json();M(g)}catch(d){console.error("Error:",d),alert("Gagal memuat data aset: "+d.message)}}else if(i){const u=i.dataset.id||c.dataset.assetId;if(confirm("Hapus aset ini?"))try{const d=await fetch(`${y}/api/assets/${u}`,{method:"DELETE",credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status}`);alert("Aset berhasil dihapus."),window.initializeApp?.()}catch(d){console.error("Error:",d),alert("Gagal menghapus: "+d.message)}}}})}function pe(){document.querySelectorAll(".modal-backdrop").forEach(e=>{const n=e.querySelector(".modal-close-btn");n&&n.addEventListener("click",()=>{e.classList.add("hidden")}),e.addEventListener("click",a=>{a.target===e&&e.classList.add("hidden")})})}function fe(){const e=document.getElementById("btn-add-gedung");e&&e.addEventListener("click",()=>N());const n=document.getElementById("btn-add-kendaraan");n&&n.addEventListener("click",()=>P());const a=document.getElementById("btn-add-driver");a&&a.addEventListener("click",()=>_());const s=document.getElementById("btn-add-asset");s&&s.addEventListener("click",()=>M())}function ye(){const e=t=>`
        <input type="hidden" id="${t}-booking-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label for="${t}-peminjam" class="form-label text-sm">Nama Peminjam / Unit</label>
            <input type="text" id="${t}-peminjam" required class="form-input"></div>
            <div><label for="${t}-name" class="form-label text-sm">Nama ${t==="gedung"?"Gedung":"Kendaraan"}</label>
            <select id="${t}-name" required class="form-input"></select></div>
            <div><label for="${t}-penanggung-jawab" class="form-label text-sm">Penanggung Jawab</label>
            <input type="text" id="${t}-penanggung-jawab" required class="form-input"></div>
            <div><label for="${t}-nomor-penanggung-jawab" class="form-label text-sm">Nomor HP</label>
            <input type="tel" id="${t}-nomor-penanggung-jawab" required class="form-input"></div>
            <div><label for="${t}-mulai-tanggal" class="form-label text-sm">Tanggal Mulai</label>
            <input type="date" id="${t}-mulai-tanggal" required class="form-input"></div>
            <div><label for="${t}-selesai-tanggal" class="form-label text-sm">Tanggal Selesai</label>
            <input type="date" id="${t}-selesai-tanggal" required class="form-input"></div>
            <div id="${t}-time-inputs" class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                <div><label for="${t}-mulai-jam" class="form-label text-sm">Jam Mulai</label>
                <input type="time" id="${t}-mulai-jam" class="form-input"></div>
                <div><label for="${t}-selesai-jam" class="form-label text-sm">Jam Selesai</label>
                <input type="time" id="${t}-selesai-jam" class="form-input"></div>
            </div>
            <div class="col-span-2 flex items-center"><input id="${t}-use-time" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
            <label for="${t}-use-time" class="ml-2 block text-sm text-gray-900">Pakai Jam Spesifik</label></div>
        </div>
    `,n=`
        <div><label for="gedung-kegiatan" class="form-label text-sm">Nama Kegiatan (Opsional)</label>
        <input type="text" id="gedung-kegiatan" class="form-input"></div>
        <div><label for="gedung-keterangan" class="form-label text-sm">Keterangan (Opsional)</label>
        <textarea id="gedung-keterangan" rows="2" class="form-input"></textarea></div>
        <div>
            <label class="form-label text-sm">Barang Dipinjam (Opsional)</label>
            <div class="grid grid-cols-5 gap-2 mb-2">
                <select id="gedung-barang-select" class="form-input col-span-3"></select>
                <input id="gedung-barang-qty" type="number" min="1" step="1" class="form-input col-span-1" placeholder="Qty">
                <button type="button" id="gedung-barang-add" class="add-btn col-span-1">Tambah</button>
            </div>
            <div id="gedung-barang-chips" class="flex flex-wrap gap-2 p-2 border rounded-md bg-gray-50 min-h-10 text-sm"></div>
        </div>
        <button type="submit" class="w-full add-btn">Simpan Peminjaman</button>
    `,a=`
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label for="kendaraan-supir" class="form-label text-sm">Supir</label>
            <select id="kendaraan-supir" class="form-input"></select></div>
            <div><label for="kendaraan-tujuan" class="form-label text-sm">Tujuan (Opsional)</label>
            <input type="text" id="kendaraan-tujuan" class="form-input"></div>
        </div>
        <div><label for="kendaraan-keterangan" class="form-label text-sm">Keterangan (Opsional)</label>
        <textarea id="kendaraan-keterangan" rows="2" class="form-input"></textarea></div>
        <button type="submit" class="w-full add-btn">Simpan Peminjaman</button>
    `,s=document.getElementById("form-gedung"),o=document.getElementById("form-kendaraan"),r=document.getElementById("form-asset");if(s&&(s.innerHTML=e("gedung")+n),o&&(o.innerHTML=e("kendaraan")+a),r){r.innerHTML=`
            <input type="hidden" id="asset-id">
            <div>
                <label for="asset-code" class="form-label text-sm">Kode</label>
                <input id="asset-code" type="text" required class="form-input" placeholder="Misal: G-01">
            </div>
            <div>
                <label for="asset-name" class="form-label text-sm">Nama</label>
                <input id="asset-name" type="text" required class="form-input" placeholder="Nama aset">
            </div>
            <div>
                <label for="asset-type" class="form-label text-sm">Tipe</label>
                <select id="asset-type" required class="form-input">
                    <option value="gedung">Gedung</option>
                    <option value="kendaraan">Kendaraan</option>
                    <option value="barang">Barang</option>
                </select>
            </div>
            <div id="asset-num-wrapper" class="hidden">
                <label for="asset-num" class="form-label text-sm">Qty / Max</label>
                <input id="asset-num" type="number" min="0" step="1" class="form-input" placeholder="Masukkan angka">
            </div>
            <div>
                <label for="asset-detail" class="form-label text-sm">Detail (Opsional)</label>
                <input id="asset-detail" type="text" class="form-input" placeholder="Kapasitas / keterangan lain">
            </div>
            <button type="submit" class="w-full add-btn">Simpan Aset</button>
        `;const t=r.querySelector("#asset-type");t&&D(t.value)}}function he(e){const n=Array.isArray(e.assets?.gedung)?e.assets.gedung:[],a=Array.isArray(e.assets?.kendaraan)?e.assets.kendaraan:[],s=Array.isArray(e.assets?.barang)?e.assets.barang:[],o=Array.isArray(e.allDrivers)?e.allDrivers:[],r=document.getElementById("gedung-name");r&&(r.innerHTML='<option value="">Pilih Gedung</option>'+n.map(c=>`<option value="${c.code}">${c.name} (${c.code})</option>`).join(""));const t=document.getElementById("kendaraan-name");t&&(t.innerHTML='<option value="">Pilih Kendaraan</option>'+a.map(c=>`<option value="${c.code}">${c.name} (${c.code})</option>`).join(""));const l=document.getElementById("kendaraan-supir");if(l){const c=o.filter(u=>u.status==="aktif");l.innerHTML='<option value="">Tanpa Supir</option>'+c.map(u=>`<option value="${u._id}">${u.name}</option>`).join("")}const i=document.getElementById("gedung-barang-select");i&&(i.innerHTML='<option value="">Pilih Barang</option>'+s.map(c=>`<option value="${c.code}">${c.name} (${c.code})</option>`).join(""))}async function be(e,n="Tanpa Supir",a,s){if(confirm("Setujui request ini?"))try{await b.approveRequest(e,"admin",n||"Tanpa Supir"),alert("Request disetujui dan booking dibuat.");const o=document.getElementById("modal-request-action");o&&o.classList.add("hidden"),await a(),s()}catch(o){alert(`Gagal: ${o.message}`)}}async function ve(e,n,a){const s=prompt("Masukkan alasan penolakan:");if(s!==null)try{await b.rejectRequest(e,s),alert("Request ditolak.");const o=document.getElementById("modal-request-action");o&&o.classList.add("hidden"),await n(),a()}catch(o){alert(`Gagal: ${o.message}`)}}function we(e,n,a,s){console.log("ðŸ“‹ showRequestDetail called with:",e),console.log("ðŸ“Ž letterFile:",e.letterFile);const o=new Date(e.startDate),r=new Date(e.endDate),l={pending:{label:"Pending",color:"bg-yellow-100 text-yellow-800"},approved:{label:"Disetujui",color:"bg-green-100 text-green-800"},rejected:{label:"Ditolak",color:"bg-red-100 text-red-800"}}[e.status]||{label:e.status,color:"bg-gray-100 text-gray-800"};let i=`
        <p><strong>ID Request:</strong> ${e.requestId}</p>
        <p><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${l.color}">${l.label}</span></p>
    `;if(e.status==="approved"&&e.bookingId&&(i+=`<p><strong>Booking ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.bookingId}</code></p>`),i+=`
        <p><strong>Tipe:</strong> ${e.bookingType==="gedung"?"Gedung":"Kendaraan"}</p>
        <p><strong>Aset:</strong> ${e.assetName}</p>
        <p><strong>Peminjam:</strong> ${e.userName}</p>
        <p><strong>Penanggung Jawab:</strong> ${e.personInCharge||"-"}</p>
        <p><strong>HP PJ:</strong> ${e.picPhoneNumber||"-"}</p>
        <p><strong>Tanggal Mulai:</strong> ${o.toLocaleDateString("id-ID")}</p>
        <p><strong>Tanggal Selesai:</strong> ${r.toLocaleDateString("id-ID")}</p>
    `,e.bookingType==="gedung")e.activityName&&(i+=`<p><strong>Kegiatan:</strong> ${e.activityName}</p>`),e.borrowedItems&&e.borrowedItems.length>0&&(i+='<p><strong>Barang Dipinjam:</strong><ul class="ml-4 list-disc">',e.borrowedItems.forEach(m=>{i+=`<li>${m.assetName} (${m.assetCode}) - ${m.quantity} unit</li>`}),i+="</ul></p>");else if(e.bookingType==="kendaraan"){if(e.driver){const m=typeof e.driver=="object"?e.driver.name:e.driver;i+=`<p><strong>Supir:</strong> ${m}</p>`}e.destination&&(i+=`<p><strong>Tujuan:</strong> ${e.destination}</p>`)}if(e.notes&&(i+=`<p><strong>Keterangan:</strong> ${e.notes}</p>`),e.letterFile&&(i+=`
            <div style="margin-top: 12px; padding: 12px; background-color: #f3f4f6; border-radius: 6px;">
                <p style="margin: 0 0 8px 0; font-weight: 600; font-size: 14px;">ðŸ“„ Surat Permohonan</p>
                <a href="/uploads/${e.letterFile}" 
                   target="_blank" 
                   style="display: inline-block; padding: 8px 12px; background-color: #3b82f6; color: white; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;">
                    <i class="fas fa-eye"></i> Lihat Surat
                </a>
            </div>
        `),e.status==="rejected"&&e.rejectionReason&&(i+=`<p><strong>Alasan Penolakan:</strong> <span class="text-red-600">${e.rejectionReason}</span></p>`),e.status==="pending"){const g=(Array.isArray(n.allDrivers)?n.allDrivers:[]).filter(f=>f.status==="aktif"),p=e.bookingType==="kendaraan"?`
            <div class="mt-3">
                <label for="req-approve-supir" class="form-label text-sm font-semibold">Pilih Supir</label>
                <select id="req-approve-supir" class="form-input">
                    <option value="">Tanpa Supir</option>
                    ${g.map(f=>`<option value="${f._id}">${f.name}</option>`).join("")}
                </select>
            </div>
        `:"";i+=`
            ${p}
            <div style="margin-top: 16px;">
                <button id="btn-approve-req" style="padding: 4px 8px; background-color: #22c55e; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; margin-right: 6px;">
                    <i class="fas fa-check"></i> Setujui
                </button>
                <button id="btn-reject-req" style="padding: 4px 8px; background-color: #ef4444; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-times"></i> Tolak
                </button>
            </div>
        `}const c=document.getElementById("modal-request-title"),u=document.getElementById("modal-request-body"),d=document.getElementById("modal-request-action");c&&(c.innerText="Detail Request"),u&&(u.innerHTML=i,e.status==="pending"&&setTimeout(()=>{const m=document.getElementById("btn-approve-req"),g=document.getElementById("btn-reject-req");if(m){const p=m.cloneNode(!0);m.parentNode.replaceChild(p,m),p.addEventListener("click",()=>{const f=document.getElementById("req-approve-supir"),E=f&&f.value||"";be(e._id,E,a,s)})}if(g){const p=g.cloneNode(!0);g.parentNode.replaceChild(p,g),p.addEventListener("click",()=>ve(e._id,a,s))}},0)),d&&d.classList.remove("hidden")}document.addEventListener("DOMContentLoaded",async()=>{ye(),await J(),ee(),Q(),U(),Y(),Ee(),O()});function O(){const e={assets:{},allBookingsCache:[],allRequestsCache:[],allDrivers:[],allAssetsCache:[]};window.__adminState=e;async function n(){try{e.allBookingsCache=await b.fetchAllBookings(),e.allRequestsCache=await b.fetchAllRequests(),e.assets=await b.fetchAssets(),e.allDrivers=await b.fetchDrivers();const a=e.allBookingsCache.filter(o=>o.bookingType==="gedung"),s=e.allBookingsCache.filter(o=>o.bookingType==="kendaraan");e.allAssetsCache=[...e.assets.gedung||[],...e.assets.kendaraan||[],...e.assets.barang||[]],he(e),w(document.getElementById("form-gedung")),v.renderRequestList(e.allRequestsCache),v.renderBookingList("gedung",a),v.renderBookingList("kendaraan",s),F(e),G(e),H(),se(e),oe(),A(e),S("gedung",e,j),S("kendaraan",e,j),re(o=>S(o,e,j),()=>A(e)),ie(()=>F(e),()=>G(e)),console.log("âœ… All data loaded and rendered")}catch(a){console.error("Error loading data:",a)}}window.showBookingDetail=(a,s="admin")=>v.showDetailModal(a,s,e),window.showRequestDetail=a=>we(a,e,n,()=>A(e)),n(),window.initializeApp=O}function Ee(){me(),ge(k),pe(),fe(),ue(),ce(),X(),Z()}window.openGedungModal=N,window.openKendaraanModal=P,window.openDriverModal=_,window.openAssetModal=M})();
