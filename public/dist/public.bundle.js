const _=()=>({assets:{gedung:[],kendaraan:[],barang:[]},drivers:[],bookings:[],viewType:"gedung",selectedAsset:"all",selectedDriver:"all"}),C=(e,t)=>{const r=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],s=a=>{const i=a.getDate(),d=r[a.getMonth()],o=a.getFullYear();return`${i} ${d} ${o}`},n=a=>a.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});return e.getHours()===0&&e.getMinutes()===0&&t.getHours()===23&&t.getMinutes()===59?e.toDateString()===t.toDateString()?s(e):`${s(e)} - ${s(t)}`:e.toDateString()===t.toDateString()?`${s(e)}, ${n(e)}-${n(t)} WIB`:`${s(e)}, ${n(e)} WIB - ${s(t)}, ${n(t)} WIB`},H=e=>({id:e._id,title:e.assetName,start:e.startDate,end:e.endDate,extendedProps:e,textColor:"#047857",backgroundColor:"rgba(184, 147, 47, 0.3)"}),G=(e,t)=>{e&&(e.innerHTML=`<div class="p-4 bg-red-50 text-red-700 rounded-lg border border-red-200">${t}</div>`)},q=async(e,t)=>{const r=await fetch(e,t),n=(r.headers.get("content-type")||"").includes("application/json"),l=n?await r.json():await r.text();if(!r.ok){const a=n&&l&&l.message?l.message:typeof l=="string"?l:"Gagal memuat data";throw new Error(a||"Gagal memuat data")}return l},S=async e=>q(`/api/public/bookings/by-code/${e}`),L=async e=>q(`/api/public/requests/by-code/${e}`),J=async()=>{const[e,t,r]=await Promise.all([q("/api/public/assets"),q("/api/public/drivers"),q("/api/public/bookings")]);return{assets:{gedung:e.gedung||[],kendaraan:e.kendaraan||[],barang:e.barang||[]},drivers:Array.isArray(t)?t:t?.drivers||[],bookings:r||[]}},O=async(e,t)=>{const r=new FormData;r.append("data",JSON.stringify(e)),t&&r.append("letterFile",t);const s=await fetch("/api/public/requests",{method:"POST",body:r}),l=(s.headers.get("content-type")||"").includes("application/json"),a=l?await s.json():await s.text();if(!s.ok){const i=l&&a&&a.message?a.message:typeof a=="string"?a:"Gagal submit request";throw new Error(i)}return a},N=(e,t)=>{if(!t.assetFilter)return;const r=e.assets[e.viewType]||[],s=e.viewType==="gedung"?"Gedung":"Kendaraan";t.assetFilter.innerHTML=`<option value="all">Semua ${s}</option>`,r.forEach(n=>{const l=new Option(n.name,n.code);t.assetFilter.add(l)}),t.assetFilter.value="all",e.selectedAsset="all"},R=(e,t)=>{if(!t.driverFilter)return;if(e.viewType!=="kendaraan"){t.driverFilter.classList.add("hidden"),t.driverFilter.innerHTML="",e.selectedDriver="all";return}t.driverFilter.classList.remove("hidden");const s=(e.drivers||[]).filter(n=>n.status==="aktif");t.driverFilter.innerHTML='<option value="all">Semua Supir</option>',s.forEach(n=>{const l=n._id||n.code||n.name,a=n.name||n.code||"Supir",i=new Option(a,l);t.driverFilter.add(i)}),t.driverFilter.value="all",e.selectedDriver="all"},K=e=>e.bookings.filter(t=>t.bookingType===e.viewType).filter(t=>e.selectedAsset==="all"||t.assetCode===e.selectedAsset).filter(t=>{if(e.viewType!=="kendaraan"||e.selectedDriver==="all")return!0;if(!t.driver)return!1;const r=t.driverCode||(typeof t.driver=="object"&&t.driver?t.driver.code:null),s=typeof t.driver=="object"&&t.driver?t.driver.name:t.driver,n=typeof t.driver=="object"&&t.driver?t.driver._id:null;return e.selectedDriver===r||e.selectedDriver===s||e.selectedDriver===n}),W=e=>{const t=()=>{e.modal?.classList.add("hidden")};return e.modal?.querySelector(".modal-close-btn")?.addEventListener("click",t),e.modal?.addEventListener("click",s=>{s.target===e.modal&&t()}),window.addEventListener("keydown",s=>{s.key==="Escape"&&(t(),e.modalFormRequest?.classList.add("hidden"))}),{closeModal:t}},z=(e,t,r)=>{if(!r.modal||!r.modalTitle||!r.modalBody)return;const s=new Date(e.startDate),n=new Date(e.endDate),l=e.assetPlate;r.modalTitle.textContent=e.bookingType==="kendaraan"&&l?`${e.assetName} (${l})`:e.assetName;let a=`<p>${C(s,n)}</p>`;if(e.status){const d={pending:{label:"Pending",color:"bg-yellow-100 text-yellow-800"},approved:{label:"Disetujui",color:"bg-green-100 text-green-800"},rejected:{label:"Ditolak",color:"bg-red-100 text-red-800"}}[e.status]||{label:e.status,color:"bg-gray-100 text-gray-800"};a+=`<p><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${d.color}">${d.label}</span></p>`}if(a+=`<p><strong>Peminjam:</strong> ${e.userName}</p>`,e.bookingType==="gedung")e.activityName&&(a+=`<p><i class="fa-solid fa-list-check mr-2" aria-hidden="true"></i>${e.activityName}</p>`),e.borrowedItems&&e.borrowedItems.length>0&&(a+='<p><i class="fa-solid fa-box mr-2" aria-hidden="true"></i>',a+=e.borrowedItems.map(i=>`${i.assetName} (${i.quantity})`).join(", "),a+="</p>");else if(e.driver){let i;if(typeof e.driver=="object"&&e.driver.name)i=e.driver.name;else if(typeof e.driver=="string"){const d=t.drivers.find(o=>o._id===e.driver||o.code===e.driver||o.name===e.driver);i=d?d.name:null}i&&(a+=`<p><strong>Supir:</strong> ${i}</p>`)}r.modalBody.innerHTML=a,r.modal.classList.remove("hidden")},U=(e,t,r)=>{if(!r.modal||!r.modalTitle||!r.modalBody)return;const s=new Date(e.startDate),n=new Date(e.endDate),l=e.assetPlate;r.modalTitle.textContent=e.bookingType==="kendaraan"&&l?`${e.assetName} (${l})`:e.assetName;let a=`<p>${C(s,n)}</p>`;if(e.status){const d={pending:{label:"Pending",color:"bg-yellow-100 text-yellow-800"},approved:{label:"Disetujui",color:"bg-green-100 text-green-800"},rejected:{label:"Ditolak",color:"bg-red-100 text-red-800"}}[e.status]||{label:e.status,color:"bg-gray-100 text-gray-800"};if(a+=`<p><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${d.color}">${d.label}</span></p>`,e.status==="rejected"&&e.rejectionReason&&(a+=`<p><strong>Alasan Penolakan:</strong> <span class="text-red-600">${e.rejectionReason}</span></p>`),e.status==="approved"){let o=e.bookingId;if(!o&&Array.isArray(t.bookings)){const c=t.bookings.find(u=>u.bookingType===e.bookingType&&u.assetCode===e.assetCode&&new Date(u.startDate).getTime()===new Date(e.startDate).getTime()&&new Date(u.endDate).getTime()===new Date(e.endDate).getTime()&&u.userName===e.userName);c&&(o=c.bookingId)}o&&(a+=`<p><strong>Booking ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${o}</code></p>`)}}else e.bookingId&&(a+=`<p><strong>Booking ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.bookingId}</code></p>`);if(e.requestId&&(a+=`<p><strong>Request ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.requestId}</code></p>`),a+=`<p><strong>Peminjam:</strong> ${e.userName}</p>`,e.personInCharge&&(a+=`<p><strong>Penanggung Jawab:</strong> ${e.personInCharge}</p>`),e.picPhoneNumber&&(a+=`<p><strong>No. Telepon:</strong> ${e.picPhoneNumber}</p>`),e.bookingType==="gedung")e.activityName&&(a+=`<p><strong>Kegiatan:</strong> ${e.activityName}</p>`),e.borrowedItems&&e.borrowedItems.length>0&&(a+='<p><strong>Barang Dipinjam:</strong></p><ul class="ml-4 list-disc">',e.borrowedItems.forEach(i=>{a+=`<li>${i.assetName} (${i.assetCode}) - ${i.quantity} unit</li>`}),a+="</ul>");else if(e.bookingType==="kendaraan"&&(e.destination&&(a+=`<p><strong>Tujuan:</strong> ${e.destination}</p>`),e.driver)){let i;if(typeof e.driver=="object"&&e.driver.name)i=e.driver.name;else if(typeof e.driver=="string"){const d=t.drivers.find(o=>o._id===e.driver||o.code===e.driver||o.name===e.driver);i=d?d.name:null}i&&(a+=`<p><strong>Supir:</strong> ${i}</p>`)}if(e.notes&&(a+=`<p><strong>Catatan:</strong> ${e.notes}</p>`),e.submissionDate){const i=new Date(e.submissionDate),d=e.approvedBy||e.createdBy||"Admin";a+=`<p class="text-sm text-gray-500 mt-2"><em>${i.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})} oleh ${d}</em></p>`}r.modalBody.innerHTML=a,r.modal.classList.remove("hidden")},Q=(e,t)=>new FullCalendar.Calendar(t.calendarEl,{initialView:window.innerWidth<768?"listWeek":"dayGridMonth",locale:"id",dayMaxEvents:!0,height:"auto",headerToolbar:{left:"prev,next,today",center:"title",right:"dayGridMonth,timeGridDay,listWeek"},buttonText:{today:"today",month:"month",day:"day",list:"list"},events:(s,n)=>{const l=K(e).map(H);n(l)},eventClick:s=>z(s.event.extendedProps,e,t),eventContent:s=>({html:(()=>{const n=s.event.extendedProps.bookingType==="kendaraan",l=s.event.extendedProps.assetPlate,a=n&&l?` (${l})`:"";return`<div class="p-1"><b>${n?"üöó":"üè¢"} ${s.event.title}${a}</b></div>`})()})}),b="07:00",h="16:00",j=(e,t)=>{if(!t.formRequest)return;const r=e.viewType,s=`
        <input type="hidden" id="req-booking-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label for="req-penanggung-jawab" class="form-label text-sm">Nama PIC/PJ</label>
            <input type="text" id="req-penanggung-jawab" required class="form-input"></div>
            <div><label for="req-hp-pj" class="form-label text-sm">No HP PIC/PJ</label>
            <input type="tel" id="req-hp-pj" required class="form-input"></div>
            <div><label for="req-name" class="form-label text-sm">Nama Unit</label>
            <input type="text" id="req-name" required class="form-input"></div>
            <div><label for="req-aset" class="form-label text-sm">Pilih ${r==="gedung"?"Gedung":"Kendaraan"}</label>
            <select id="req-aset" required class="form-input"></select></div>
            <div><label for="req-mulai-tanggal" class="form-label text-sm">Tanggal Mulai</label>
            <input type="date" id="req-mulai-tanggal" required class="form-input"></div>
            <div><label for="req-selesai-tanggal" class="form-label text-sm">Tanggal Selesai</label>
            <input type="date" id="req-selesai-tanggal" required class="form-input"></div>
            <div id="req-time-inputs" class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                <div><label for="req-mulai-jam" class="form-label text-sm">Jam Mulai</label>
                <input type="time" id="req-mulai-jam" class="form-input"></div>
                <div><label for="req-selesai-jam" class="form-label text-sm">Jam Selesai</label>
                <input type="time" id="req-selesai-jam" class="form-input"></div>
            </div>
            <div class="col-span-2 flex items-center"><input id="req-use-time" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
            <label for="req-use-time" class="ml-2 block text-sm text-gray-900">Pakai Jam Spesifik</label></div>
        </div>
    `,n=`
        <div><label for="req-kegiatan" class="form-label text-sm">Nama Kegiatan</label>
        <input type="text" id="req-kegiatan" class="form-input"></div>
        <div>
            <label class="form-label text-sm">Barang Dipinjam (Opsional)</label>
            <div class="grid grid-cols-5 gap-2 mb-2">
                <select id="req-barang-select" class="form-input col-span-3"></select>
                <input id="req-barang-qty" type="number" min="1" step="1" class="form-input col-span-1" placeholder="Qty">
                <button type="button" id="req-barang-add" class="add-btn col-span-1">+</button>
            </div>
            <div id="req-barang-chips" class="flex flex-wrap gap-2 p-2 border rounded-md bg-gray-50 min-h-10 text-sm"></div>
        </div>
        <div><label for="req-keterangan" class="form-label text-sm">Keterangan (Opsional)</label>
        <textarea id="req-keterangan" rows="2" class="form-input"></textarea></div>
        <div><label for="req-surat" class="form-label text-sm">Upload Surat</label>
        <input type="file" id="req-surat" class="form-input" accept=".pdf,.doc,.docx,.jpg,.png"></div>
        <button type="submit" class="w-full add-btn save-btn">Submit Request</button>
    `,l=`
        <div><label for="req-tujuan" class="form-label text-sm">Tujuan</label>
        <input type="text" id="req-tujuan" class="form-input"></div>
        <div><label for="req-keterangan" class="form-label text-sm">Keterangan (Opsional)</label>
        <textarea id="req-keterangan" rows="2" class="form-input"></textarea></div>
        <div><label for="req-surat" class="form-label text-sm">Upload Surat</label>
        <input type="file" id="req-surat" class="form-input" accept=".pdf,.doc,.docx,.jpg,.png"></div>
        <button type="submit" class="w-full add-btn save-btn">Submit Request</button>
    `;t.formRequest.innerHTML=s+(r==="gedung"?n:l),T(e),V(e,t)},T=(e,t,r=new Set)=>{const s=document.getElementById("req-aset");if(!s)return;const n=e.viewType==="gedung"?e.assets.gedung:e.assets.kendaraan;s.innerHTML="",n.forEach(l=>{const a=new Option(l.name,l.code);r.has(l.code)&&(a.disabled=!0,a.text=`${l.name} (Tidak Tersedia)`),s.add(a)})},y=(e,t)=>{const r=document.getElementById("req-use-time")?.checked,s=document.getElementById("req-mulai-tanggal"),n=document.getElementById("req-selesai-tanggal"),l=document.getElementById("req-mulai-jam"),a=document.getElementById("req-selesai-jam");if(!s?.value||!n?.value){T(e);return}let i,d;if(r&&l?.value&&a?.value)i=new Date(`${s.value}T${l.value}`),d=new Date(`${n.value}T${a.value}`);else{const c=e.viewType==="gedung"?b:"00:00",u=e.viewType==="gedung"?h:"23:59";i=new Date(`${s.value}T${c}`),d=new Date(`${n.value}T${u}`)}if(isNaN(i)||isNaN(d)||i>=d){T(e);return}const o=new Set;e.bookings.forEach(c=>{if(c.bookingType!==e.viewType)return;const u=new Date(c.startDate),p=new Date(c.endDate);i<p&&d>u&&o.add(c.assetCode)}),T(e,t,o)},V=(e,t)=>{const r=document.getElementById("req-use-time"),s=document.getElementById("req-time-inputs"),n=document.getElementById("req-mulai-tanggal"),l=document.getElementById("req-selesai-tanggal");if(!(!r||!s||!n||!l)){if(r.addEventListener("change",()=>{s.classList.toggle("hidden",!r.checked),y(e,t),v(e,t)}),n.addEventListener("change",()=>{l.min=n.value,y(e,t),v(e,t)}),l.addEventListener("change",()=>{y(e,t),v(e,t)}),document.getElementById("req-mulai-jam")?.addEventListener("change",()=>{y(e,t),v(e,t)}),document.getElementById("req-selesai-jam")?.addEventListener("change",()=>{y(e,t),v(e,t)}),e.viewType==="gedung"){k(e,t);const a=document.getElementById("req-barang-add"),i=document.getElementById("req-barang-qty"),d=document.getElementById("req-barang-select");d?.addEventListener("change",()=>I(e,t)),i?.addEventListener("input",()=>I(e,t)),a?.addEventListener("click",o=>{o.preventDefault();const c=d?.value,u=Number(i?.value);if(c&&u>0){const p=d?.options[d?.selectedIndex]?.text||c;Y(e,t,c,p,u),i.value="",I(e,t)}})}v(e,t)}},v=(e,t)=>{const r=document.getElementById("req-use-time")?.checked,s=document.getElementById("req-mulai-tanggal"),n=document.getElementById("req-selesai-tanggal"),l=document.getElementById("req-mulai-jam"),a=document.getElementById("req-selesai-jam");if(!s?.value||!n?.value)return;let i,d;r?!l?.value||!a?.value?(i=new Date(`${s.value}T${b}`),d=new Date(`${n.value}T${h}`)):(i=new Date(`${s.value}T${l.value}`),d=new Date(`${n.value}T${a.value}`)):(i=new Date(`${s.value}T${b}`),d=new Date(`${n.value}T${h}`)),!(isNaN(i)||isNaN(d)||i>=d)&&e.viewType==="gedung"&&Z(e,t,i,d)},Z=(e,t,r,s)=>{const n=new Map;e.bookings.forEach(d=>{if(d.bookingType!=="gedung")return;const o=new Date(d.startDate),c=new Date(d.endDate);r<c&&s>o&&Array.isArray(d.borrowedItems)&&d.borrowedItems.forEach(u=>{u&&u.assetCode&&n.set(u.assetCode,(n.get(u.assetCode)||0)+Number(u.quantity||0))})});const l=new Map;(e.assets.barang||[]).forEach(d=>{const o=Number(d.num||0),c=n.get(d.code)||0;l.set(d.code,Math.max(0,o-c))});const a=t.formRequest;(a.__barangItems?[...a.__barangItems.values()]:[]).forEach(d=>{const o=l.get(d.assetCode)??0;l.set(d.assetCode,Math.max(0,o-Number(d.quantity||0)))}),a.__barangAvailability=l,A(t,e.assets.barang||[],l),I(e,t)},A=(e,t,r=null)=>{const s=document.getElementById("req-barang-select");if(!s)return;const n=s.value;s.innerHTML="",t.forEach(l=>{const a=r?r.get(l.code)??l.num??0:l.num??0,i=new Option(`${l.name} (stok: ${a})`,l.code);i.disabled=a<=0,s.add(i)}),n&&(s.value=n)},I=(e,t)=>{const r=document.getElementById("req-barang-select"),s=document.getElementById("req-barang-qty");if(!r||!s)return;const n=r.value||null,l=t.formRequest?.__barangAvailability;let a=0;if(l&&n&&(a=l.get(n)??0),a<0&&(a=0),s.max=String(a),s.placeholder=a>0?`Qty (maks: ${a})`:"Qty",s.value){const i=Number(s.value);Number.isFinite(i)&&i>a&&(s.value=a)}s.disabled=a===0},k=(e,t)=>{t.formRequest.__barangItems=new Map;const r=document.getElementById("req-barang-chips");r&&(r.innerHTML=""),A(t,e.assets.barang||[])},Y=(e,t,r,s,n)=>{const l=t.formRequest;l.__barangItems||(l.__barangItems=new Map),l.__barangItems.set(r,{assetCode:r,assetName:s,quantity:n});const a=document.getElementById("req-barang-chips"),i=document.createElement("span");i.className="inline-flex items-center bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full",i.dataset.code=r,i.innerHTML=`
        <span class="mr-1 font-semibold">${s}: ${n}</span>
        <button type="button" class="ml-1 text-emerald-800 hover:text-red-600" title="Hapus">&times;</button>
    `,a?.querySelectorAll("span[data-code]").forEach(d=>{d.dataset.code===r&&d.remove()}),a?.appendChild(i),i.querySelector("button")?.addEventListener("click",()=>{l.__barangItems.delete(r),i.remove()})},X=async(e,t,r,s)=>{e.preventDefault();const n=r.formRequest,l=n.querySelector("#req-mulai-tanggal").value,a=n.querySelector("#req-selesai-tanggal").value,i=n.querySelector("#req-use-time")?.checked;if(!l||!a){alert("Tanggal mulai dan selesai wajib diisi.");return}const d=new Date(l),o=new Date(a);if(d>o){alert("Tanggal selesai harus setelah atau sama dengan tanggal mulai.");return}let c,u;if(i){const m=n.querySelector("#req-mulai-jam")?.value,g=n.querySelector("#req-selesai-jam")?.value;t.viewType==="gedung"&&(!m||!g)?(c=new Date(`${l}T${b}`),u=new Date(`${a}T${h}`)):(c=new Date(`${l}T${m||"00:00"}`),u=new Date(`${a}T${g||"23:59"}`))}else{const m=t.viewType==="gedung"?b:"00:00",g=t.viewType==="gedung"?h:"23:59";c=new Date(`${l}T${m}`),u=new Date(`${a}T${g}`)}const p=n.querySelector("#req-aset").value,x=(t.viewType==="gedung"?t.assets.gedung:t.assets.kendaraan).find(m=>m.code===p),P=x?x.name:p,f={bookingType:t.viewType,userName:n.querySelector("#req-name").value,personInCharge:n.querySelector("#req-penanggung-jawab").value,picPhoneNumber:n.querySelector("#req-hp-pj").value,assetCode:p,assetName:P,startDate:c.toISOString(),endDate:u.toISOString(),notes:n.querySelector("#req-keterangan")?.value};if(t.viewType==="gedung"){const m=n.__barangItems||new Map;m.size&&(f.borrowedItems=Array.from(m.values())),f.activityName=n.querySelector("#req-kegiatan")?.value}else f.driver=null,f.destination=n.querySelector("#req-tujuan")?.value;try{const m=n.querySelector("#req-surat"),g=m&&m.files&&m.files[0]?m.files[0]:null,E=await O(f,g),w=document.getElementById("request-code-modal"),$=document.getElementById("request-code-text"),D=document.getElementById("request-code-copy-btn"),B=w.querySelector(".modal-close-btn");w&&$&&D&&B?($.textContent=E.requestId,w.classList.remove("hidden"),D.onclick=()=>{navigator.clipboard.writeText(E.requestId),D.innerHTML='<i class="fas fa-check"></i> Copied',setTimeout(()=>{D.innerHTML='<i class="fas fa-copy"></i> Copy'},1500)},B.onclick=()=>{w.classList.add("hidden"),n.reset(),r.modalFormRequest.classList.add("hidden"),s.refetchEvents()}):(alert(`Request berhasil diajukan! ID Request: ${E.requestId}`),n.reset(),r.modalFormRequest.classList.add("hidden"),s.refetchEvents())}catch(m){alert(`Error: ${m.message}`)}};let F=!1;async function M(){if(F)return;F=!0;const e=_(),t={calendarEl:document.getElementById("calendar"),assetFilter:document.getElementById("calendar-asset-filter"),driverFilter:document.getElementById("calendar-driver-filter"),tabGedung:document.getElementById("calendar-tab-gedung"),tabKendaraan:document.getElementById("calendar-tab-kendaraan"),modal:document.getElementById("modal-detail-event"),modalTitle:document.getElementById("modal-title"),modalBody:document.getElementById("modal-body"),btnSearchBooking:document.getElementById("btn-search-booking"),btnFormRequest:document.getElementById("btn-form"),modalFormRequest:document.getElementById("modal-form-request"),formRequest:document.getElementById("form-request")};if(!t.calendarEl)return;const r=Q(e,t);W(t);const s=a=>{e.viewType=a,t.tabGedung?.classList.toggle("active",a==="gedung"),t.tabKendaraan?.classList.toggle("active",a==="kendaraan"),N(e,t),R(e,t),j(e,t),r.refetchEvents()};t.tabGedung?.addEventListener("click",()=>s("gedung")),t.tabKendaraan?.addEventListener("click",()=>s("kendaraan")),t.assetFilter?.addEventListener("change",a=>{e.selectedAsset=a.target.value||"all",r.refetchEvents()}),t.driverFilter?.addEventListener("change",a=>{e.selectedDriver=a.target.value||"all",r.refetchEvents()}),t.btnFormRequest&&t.btnFormRequest.addEventListener("click",()=>{j(e,t),t.modalFormRequest.classList.remove("hidden")}),t.formRequest&&t.formRequest.addEventListener("submit",a=>{X(a,e,t,r)}),t.modalFormRequest?.querySelector(".modal-close-btn")?.addEventListener("click",()=>t.modalFormRequest.classList.add("hidden")),t.modalFormRequest?.querySelector(".modal-reset-btn")?.addEventListener("click",a=>{a.stopPropagation(),t.formRequest&&(t.formRequest.reset(),e.viewType==="gedung"&&k(e,t))}),t.modalFormRequest?.addEventListener("click",a=>{a.target===t.modalFormRequest&&t.modalFormRequest.classList.add("hidden")}),t.btnSearchBooking&&t.btnSearchBooking.addEventListener("click",async()=>{const a=prompt("Masukkan Booking ID atau Request ID");if(a)try{const i=a.trim();let d;if(/^\d{6}-[A-Z0-9]{5}$/i.test(i))d=await S(i);else if(/^[A-Z0-9]{5}$/i.test(i))d=await L(i);else try{d=await S(i)}catch{d=await L(i)}U(d,e,t)}catch(i){alert(i.message||"Data tidak ditemukan")}});try{const a=await J();e.assets=a.assets,e.drivers=a.drivers;const i=Array.isArray(a.assets?.kendaraan)?a.assets.kendaraan:[],d=new Map(i.map(o=>[o.code,o]));e.bookings=(a.bookings||[]).map(o=>{if(o?.bookingType==="kendaraan"){const c=d.get(o.assetCode),u=c&&typeof c.plate=="string"&&c.plate.trim()?c.plate.trim():null;return u?{...o,assetPlate:u}:{...o,assetPlate:null}}return o}),N(e,t),R(e,t),r.refetchEvents()}catch(a){console.error("Gagal memuat data",a),G(t.calendarEl?.parentElement,"Tidak dapat memuat jadwal. Coba beberapa saat lagi.")}r.render(),s("gedung")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M):M();
