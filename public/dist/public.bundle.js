const M=()=>({assets:{gedung:[],kendaraan:[],barang:[]},drivers:[],bookings:[],viewType:"gedung",selectedAsset:"all",selectedDriver:"all"}),R=(e,t)=>{const i=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],r=a=>{const l=a.getDate(),d=i[a.getMonth()],c=a.getFullYear();return`${l} ${d} ${c}`},s=a=>a.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});return e.getHours()===0&&e.getMinutes()===0&&t.getHours()===23&&t.getMinutes()===59?e.toDateString()===t.toDateString()?r(e):`${r(e)} - ${r(t)}`:e.toDateString()===t.toDateString()?`${r(e)}, ${s(e)}-${s(t)} WIB`:`${r(e)}, ${s(e)} WIB - ${r(t)}, ${s(t)} WIB`},C=e=>({id:e._id,title:e.assetName,start:e.startDate,end:e.endDate,extendedProps:e,textColor:"#047857",backgroundColor:"rgba(184, 147, 47, 0.3)"}),A=(e,t)=>{e&&(e.innerHTML=`<div class="p-4 bg-red-50 text-red-700 rounded-lg border border-red-200">${t}</div>`)},q=async(e,t)=>{const i=await fetch(e,t),s=(i.headers.get("content-type")||"").includes("application/json"),n=s?await i.json():await i.text();if(!i.ok){const a=s&&n&&n.message?n.message:typeof n=="string"?n:"Gagal memuat data";throw new Error(a||"Gagal memuat data")}return n},I=async e=>q(`/api/public/bookings/by-code/${e}`),E=async e=>q(`/api/public/requests/by-code/${e}`),k=async()=>{const[e,t,i]=await Promise.all([q("/api/public/assets"),q("/api/public/drivers"),q("/api/public/bookings")]);return{assets:{gedung:e.gedung||[],kendaraan:e.kendaraan||[],barang:e.barang||[]},drivers:Array.isArray(t)?t:t?.drivers||[],bookings:i||[]}},_=async(e,t)=>{const i=new FormData;i.append("data",JSON.stringify(e)),t&&i.append("letterFile",t);const r=await fetch("/api/public/requests",{method:"POST",body:i}),n=(r.headers.get("content-type")||"").includes("application/json"),a=n?await r.json():await r.text();if(!r.ok){const l=n&&a&&a.message?a.message:typeof a=="string"?a:"Gagal submit request";throw new Error(l)}return a},$=(e,t)=>{if(!t.assetFilter)return;const i=e.assets[e.viewType]||[],r=e.viewType==="gedung"?"Gedung":"Kendaraan";t.assetFilter.innerHTML=`<option value="all">Semua ${r}</option>`,i.forEach(s=>{const n=new Option(s.name,s.code);t.assetFilter.add(n)}),t.assetFilter.value="all",e.selectedAsset="all"},x=(e,t)=>{if(!t.driverFilter)return;if(e.viewType!=="kendaraan"){t.driverFilter.classList.add("hidden"),t.driverFilter.innerHTML="",e.selectedDriver="all";return}t.driverFilter.classList.remove("hidden");const r=(e.drivers||[]).filter(s=>s.status==="aktif");t.driverFilter.innerHTML='<option value="all">Semua Supir</option>',r.forEach(s=>{const n=s._id||s.code||s.name,a=s.name||s.code||"Supir",l=new Option(a,n);t.driverFilter.add(l)}),t.driverFilter.value="all",e.selectedDriver="all"},P=e=>e.bookings.filter(t=>t.bookingType===e.viewType).filter(t=>e.selectedAsset==="all"||t.assetCode===e.selectedAsset).filter(t=>{if(e.viewType!=="kendaraan"||e.selectedDriver==="all")return!0;if(!t.driver)return!1;const i=t.driverCode||(typeof t.driver=="object"&&t.driver?t.driver.code:null),r=typeof t.driver=="object"&&t.driver?t.driver.name:t.driver,s=typeof t.driver=="object"&&t.driver?t.driver._id:null;return e.selectedDriver===i||e.selectedDriver===r||e.selectedDriver===s}),H=e=>{const t=()=>{e.modal?.classList.add("hidden")};return e.modal?.querySelector(".modal-close-btn")?.addEventListener("click",t),e.modal?.addEventListener("click",r=>{r.target===e.modal&&t()}),window.addEventListener("keydown",r=>{r.key==="Escape"&&(t(),e.modalFormRequest?.classList.add("hidden"))}),{closeModal:t}},G=(e,t,i)=>{if(!i.modal||!i.modalTitle||!i.modalBody)return;const r=new Date(e.startDate),s=new Date(e.endDate);i.modalTitle.textContent=e.bookingType==="kendaraan"?`${e.assetName} (${e.assetCode})`:e.assetName;let n=`<p>${R(r,s)}</p>`;if(e.status){const l={pending:{label:"Pending",color:"bg-yellow-100 text-yellow-800"},approved:{label:"Disetujui",color:"bg-green-100 text-green-800"},rejected:{label:"Ditolak",color:"bg-red-100 text-red-800"}}[e.status]||{label:e.status,color:"bg-gray-100 text-gray-800"};n+=`<p><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${l.color}">${l.label}</span></p>`}if(n+=`<p><strong>Peminjam:</strong> ${e.userName}</p>`,e.bookingType==="gedung")e.activityName&&(n+=`<p><i class="fa-solid fa-list-check mr-2" aria-hidden="true"></i>${e.activityName}</p>`),e.borrowedItems&&e.borrowedItems.length>0&&(n+='<p><i class="fa-solid fa-box mr-2" aria-hidden="true"></i>',n+=e.borrowedItems.map(a=>`${a.assetName} (${a.quantity})`).join(", "),n+="</p>");else if(e.driver){let a;if(typeof e.driver=="object"&&e.driver.name)a=e.driver.name;else if(typeof e.driver=="string"){const l=t.drivers.find(d=>d._id===e.driver||d.code===e.driver||d.name===e.driver);a=l?l.name:null}a&&(n+=`<p><strong>Supir:</strong> ${a}</p>`)}i.modalBody.innerHTML=n,i.modal.classList.remove("hidden")},J=(e,t,i)=>{if(!i.modal||!i.modalTitle||!i.modalBody)return;const r=new Date(e.startDate),s=new Date(e.endDate);i.modalTitle.textContent=e.bookingType==="kendaraan"?`${e.assetName} (${e.assetCode})`:e.assetName;let n=`<p>${R(r,s)}</p>`;if(e.status){const l={pending:{label:"Pending",color:"bg-yellow-100 text-yellow-800"},approved:{label:"Disetujui",color:"bg-green-100 text-green-800"},rejected:{label:"Ditolak",color:"bg-red-100 text-red-800"}}[e.status]||{label:e.status,color:"bg-gray-100 text-gray-800"};if(n+=`<p><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${l.color}">${l.label}</span></p>`,e.status==="rejected"&&e.rejectionReason&&(n+=`<p><strong>Alasan Penolakan:</strong> <span class="text-red-600">${e.rejectionReason}</span></p>`),e.status==="approved"){let d=e.bookingId;if(!d&&Array.isArray(t.bookings)){const c=t.bookings.find(o=>o.bookingType===e.bookingType&&o.assetCode===e.assetCode&&new Date(o.startDate).getTime()===new Date(e.startDate).getTime()&&new Date(o.endDate).getTime()===new Date(e.endDate).getTime()&&o.userName===e.userName);c&&(d=c.bookingId)}d&&(n+=`<p><strong>Booking ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${d}</code></p>`)}}else e.bookingId&&(n+=`<p><strong>Booking ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.bookingId}</code></p>`);if(e.requestId&&(n+=`<p><strong>Request ID:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.requestId}</code></p>`),n+=`<p><strong>Peminjam:</strong> ${e.userName}</p>`,e.personInCharge&&(n+=`<p><strong>Penanggung Jawab:</strong> ${e.personInCharge}</p>`),e.picPhoneNumber&&(n+=`<p><strong>No. Telepon:</strong> ${e.picPhoneNumber}</p>`),e.bookingType==="gedung")e.activityName&&(n+=`<p><strong>Kegiatan:</strong> ${e.activityName}</p>`),e.borrowedItems&&e.borrowedItems.length>0&&(n+='<p><strong>Barang Dipinjam:</strong></p><ul class="ml-4 list-disc">',e.borrowedItems.forEach(a=>{n+=`<li>${a.assetName} (${a.assetCode}) - ${a.quantity} unit</li>`}),n+="</ul>");else if(e.bookingType==="kendaraan"&&(e.destination&&(n+=`<p><strong>Tujuan:</strong> ${e.destination}</p>`),e.driver)){let a;if(typeof e.driver=="object"&&e.driver.name)a=e.driver.name;else if(typeof e.driver=="string"){const l=t.drivers.find(d=>d._id===e.driver||d.code===e.driver||d.name===e.driver);a=l?l.name:null}a&&(n+=`<p><strong>Supir:</strong> ${a}</p>`)}if(e.notes&&(n+=`<p><strong>Catatan:</strong> ${e.notes}</p>`),e.submissionDate){const a=new Date(e.submissionDate);n+=`<p class="text-sm text-gray-500 mt-2"><em>Diajukan: ${a.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}</em></p>`}i.modalBody.innerHTML=n,i.modal.classList.remove("hidden")},O=(e,t)=>new FullCalendar.Calendar(t.calendarEl,{initialView:window.innerWidth<768?"listWeek":"dayGridMonth",locale:"id",dayMaxEvents:!0,height:"auto",headerToolbar:{left:"prev,next,today",center:"title",right:"dayGridMonth,timeGridDay,listWeek"},buttonText:{today:"today",month:"month",day:"day",list:"list"},events:(r,s)=>{const n=P(e).map(C);s(n)},eventClick:r=>G(r.event.extendedProps,e,t),eventContent:r=>({html:`<div class="p-1"><b>${r.event.extendedProps.bookingType==="gedung"?"üè¢":"üöó"} ${r.event.title}</b></div>`})}),b="07:00",h="16:00",B=(e,t)=>{if(!t.formRequest)return;const i=e.viewType,r=`
        <input type="hidden" id="req-booking-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label for="req-penanggung-jawab" class="form-label text-sm">Nama PIC/PJ</label>
            <input type="text" id="req-penanggung-jawab" required class="form-input"></div>
            <div><label for="req-hp-pj" class="form-label text-sm">No HP PIC/PJ</label>
            <input type="tel" id="req-hp-pj" required class="form-input"></div>
            <div><label for="req-name" class="form-label text-sm">Nama Unit</label>
            <input type="text" id="req-name" required class="form-input"></div>
            <div><label for="req-aset" class="form-label text-sm">Pilih ${i==="gedung"?"Gedung":"Kendaraan"}</label>
            <select id="req-aset" required class="form-input"></select></div>
            <div><label for="req-mulai-tanggal" class="form-label text-sm">Tanggal Mulai</label>
            <input type="date" id="req-mulai-tanggal" required class="form-input"></div>
            <div><label for="req-selesai-tanggal" class="form-label text-sm">Tanggal Selesai</label>
            <input type="date" id="req-selesai-tanggal" required class="form-input"></div>
            <div id="req-time-inputs" class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                <div><label for="req-mulai-jam" class="form-label text-sm">Jam Mulai</label>
                <input type="time" id="req-mulai-jam" class="form-input"></div>
                <div><label for="req-selesai-jam" class="form-label text-sm">Jam Selesai</label>
                <input type="time" id="req-selesai-jam" class="form-input"></div>
            </div>
            <div class="col-span-2 flex items-center"><input id="req-use-time" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
            <label for="req-use-time" class="ml-2 block text-sm text-gray-900">Pakai Jam Spesifik</label></div>
        </div>
    `,s=`
        <div><label for="req-kegiatan" class="form-label text-sm">Nama Kegiatan</label>
        <input type="text" id="req-kegiatan" class="form-input"></div>
        <div>
            <label class="form-label text-sm">Barang Dipinjam (Opsional)</label>
            <div class="grid grid-cols-5 gap-2 mb-2">
                <select id="req-barang-select" class="form-input col-span-3"></select>
                <input id="req-barang-qty" type="number" min="1" step="1" class="form-input col-span-1" placeholder="Qty">
                <button type="button" id="req-barang-add" class="add-btn col-span-1">+</button>
            </div>
            <div id="req-barang-chips" class="flex flex-wrap gap-2 p-2 border rounded-md bg-gray-50 min-h-10 text-sm"></div>
        </div>
        <div><label for="req-keterangan" class="form-label text-sm">Keterangan (Opsional)</label>
        <textarea id="req-keterangan" rows="2" class="form-input"></textarea></div>
        <div><label for="req-surat" class="form-label text-sm">Upload Surat</label>
        <input type="file" id="req-surat" class="form-input" accept=".pdf,.doc,.docx,.jpg,.png"></div>
        <button type="submit" class="w-full add-btn save-btn">Submit Request</button>
    `,n=`
        <div><label for="req-tujuan" class="form-label text-sm">Tujuan</label>
        <input type="text" id="req-tujuan" class="form-input"></div>
        <div><label for="req-keterangan" class="form-label text-sm">Keterangan (Opsional)</label>
        <textarea id="req-keterangan" rows="2" class="form-input"></textarea></div>
        <div><label for="req-surat" class="form-label text-sm">Upload Surat</label>
        <input type="file" id="req-surat" class="form-input" accept=".pdf,.doc,.docx,.jpg,.png"></div>
        <button type="submit" class="w-full add-btn save-btn">Submit Request</button>
    `;t.formRequest.innerHTML=r+(i==="gedung"?s:n),w(e),K(e,t)},w=(e,t,i=new Set)=>{const r=document.getElementById("req-aset");if(!r)return;const s=e.viewType==="gedung"?e.assets.gedung:e.assets.kendaraan;r.innerHTML="",s.forEach(n=>{const a=new Option(n.name,n.code);i.has(n.code)&&(a.disabled=!0,a.text=`${n.name} (Tidak Tersedia)`),r.add(a)})},y=(e,t)=>{const i=document.getElementById("req-use-time")?.checked,r=document.getElementById("req-mulai-tanggal"),s=document.getElementById("req-selesai-tanggal"),n=document.getElementById("req-mulai-jam"),a=document.getElementById("req-selesai-jam");if(!r?.value||!s?.value){w(e);return}let l,d;if(i&&n?.value&&a?.value)l=new Date(`${r.value}T${n.value}`),d=new Date(`${s.value}T${a.value}`);else{const o=e.viewType==="gedung"?b:"00:00",u=e.viewType==="gedung"?h:"23:59";l=new Date(`${r.value}T${o}`),d=new Date(`${s.value}T${u}`)}if(isNaN(l)||isNaN(d)||l>=d){w(e);return}const c=new Set;e.bookings.forEach(o=>{if(o.bookingType!==e.viewType)return;const u=new Date(o.startDate),p=new Date(o.endDate);l<p&&d>u&&c.add(o.assetCode)}),w(e,t,c)},K=(e,t)=>{const i=document.getElementById("req-use-time"),r=document.getElementById("req-time-inputs"),s=document.getElementById("req-mulai-tanggal"),n=document.getElementById("req-selesai-tanggal");if(!(!i||!r||!s||!n)){if(i.addEventListener("change",()=>{r.classList.toggle("hidden",!i.checked),y(e,t),v(e,t)}),s.addEventListener("change",()=>{n.min=s.value,y(e,t),v(e,t)}),n.addEventListener("change",()=>{y(e,t),v(e,t)}),document.getElementById("req-mulai-jam")?.addEventListener("change",()=>{y(e,t),v(e,t)}),document.getElementById("req-selesai-jam")?.addEventListener("change",()=>{y(e,t),v(e,t)}),e.viewType==="gedung"){z(e,t);const a=document.getElementById("req-barang-add"),l=document.getElementById("req-barang-qty"),d=document.getElementById("req-barang-select");d?.addEventListener("change",()=>D(e,t)),l?.addEventListener("input",()=>D(e,t)),a?.addEventListener("click",c=>{c.preventDefault();const o=d?.value,u=Number(l?.value);if(o&&u>0){const p=d?.options[d?.selectedIndex]?.text||o;U(e,t,o,p,u),l.value="",D(e,t)}})}v(e,t)}},v=(e,t)=>{const i=document.getElementById("req-use-time")?.checked,r=document.getElementById("req-mulai-tanggal"),s=document.getElementById("req-selesai-tanggal"),n=document.getElementById("req-mulai-jam"),a=document.getElementById("req-selesai-jam");if(!r?.value||!s?.value)return;let l,d;i?!n?.value||!a?.value?(l=new Date(`${r.value}T${b}`),d=new Date(`${s.value}T${h}`)):(l=new Date(`${r.value}T${n.value}`),d=new Date(`${s.value}T${a.value}`)):(l=new Date(`${r.value}T${b}`),d=new Date(`${s.value}T${h}`)),!(isNaN(l)||isNaN(d)||l>=d)&&e.viewType==="gedung"&&W(e,t,l,d)},W=(e,t,i,r)=>{const s=new Map;e.bookings.forEach(d=>{if(d.bookingType!=="gedung")return;const c=new Date(d.startDate),o=new Date(d.endDate);i<o&&r>c&&Array.isArray(d.borrowedItems)&&d.borrowedItems.forEach(u=>{u&&u.assetCode&&s.set(u.assetCode,(s.get(u.assetCode)||0)+Number(u.quantity||0))})});const n=new Map;(e.assets.barang||[]).forEach(d=>{const c=Number(d.num||0),o=s.get(d.code)||0;n.set(d.code,Math.max(0,c-o))});const a=t.formRequest;(a.__barangItems?[...a.__barangItems.values()]:[]).forEach(d=>{const c=n.get(d.assetCode)??0;n.set(d.assetCode,Math.max(0,c-Number(d.quantity||0)))}),a.__barangAvailability=n,N(t,e.assets.barang||[],n),D(e,t)},N=(e,t,i=null)=>{const r=document.getElementById("req-barang-select");if(!r)return;const s=r.value;r.innerHTML="",t.forEach(n=>{const a=i?i.get(n.code)??n.num??0:n.num??0,l=new Option(`${n.name} (stok: ${a})`,n.code);l.disabled=a<=0,r.add(l)}),s&&(r.value=s)},D=(e,t)=>{const i=document.getElementById("req-barang-select"),r=document.getElementById("req-barang-qty");if(!i||!r)return;const s=i.value||null,n=t.formRequest?.__barangAvailability;let a=0;if(n&&s&&(a=n.get(s)??0),a<0&&(a=0),r.max=String(a),r.placeholder=a>0?`Qty (maks: ${a})`:"Qty",r.value){const l=Number(r.value);Number.isFinite(l)&&l>a&&(r.value=a)}r.disabled=a===0},z=(e,t)=>{t.formRequest.__barangItems=new Map;const i=document.getElementById("req-barang-chips");i&&(i.innerHTML=""),N(t,e.assets.barang||[])},U=(e,t,i,r,s)=>{const n=t.formRequest;n.__barangItems||(n.__barangItems=new Map),n.__barangItems.set(i,{assetCode:i,assetName:r,quantity:s});const a=document.getElementById("req-barang-chips"),l=document.createElement("span");l.className="inline-flex items-center bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full",l.dataset.code=i,l.innerHTML=`
        <span class="mr-1 font-semibold">${r}: ${s}</span>
        <button type="button" class="ml-1 text-emerald-800 hover:text-red-600" title="Hapus">&times;</button>
    `,a?.querySelectorAll("span[data-code]").forEach(d=>{d.dataset.code===i&&d.remove()}),a?.appendChild(l),l.querySelector("button")?.addEventListener("click",()=>{n.__barangItems.delete(i),l.remove()})},Q=async(e,t,i,r)=>{e.preventDefault();const s=i.formRequest,n=s.querySelector("#req-mulai-tanggal").value,a=s.querySelector("#req-selesai-tanggal").value,l=s.querySelector("#req-use-time")?.checked;if(!n||!a){alert("Tanggal mulai dan selesai wajib diisi.");return}const d=new Date(n),c=new Date(a);if(d>c){alert("Tanggal selesai harus setelah atau sama dengan tanggal mulai.");return}let o,u;if(l){const m=s.querySelector("#req-mulai-jam")?.value,g=s.querySelector("#req-selesai-jam")?.value;t.viewType==="gedung"&&(!m||!g)?(o=new Date(`${n}T${b}`),u=new Date(`${a}T${h}`)):(o=new Date(`${n}T${m||"00:00"}`),u=new Date(`${a}T${g||"23:59"}`))}else{const m=t.viewType==="gedung"?b:"00:00",g=t.viewType==="gedung"?h:"23:59";o=new Date(`${n}T${m}`),u=new Date(`${a}T${g}`)}const p=s.querySelector("#req-aset").value,T=(t.viewType==="gedung"?t.assets.gedung:t.assets.kendaraan).find(m=>m.code===p),j=T?T.name:p,f={bookingType:t.viewType,userName:s.querySelector("#req-name").value,personInCharge:s.querySelector("#req-penanggung-jawab").value,picPhoneNumber:s.querySelector("#req-hp-pj").value,assetCode:p,assetName:j,startDate:o.toISOString(),endDate:u.toISOString(),notes:s.querySelector("#req-keterangan")?.value};if(t.viewType==="gedung"){const m=s.__barangItems||new Map;m.size&&(f.borrowedItems=Array.from(m.values())),f.activityName=s.querySelector("#req-kegiatan")?.value}else f.driver=null,f.destination=s.querySelector("#req-tujuan")?.value;try{const m=s.querySelector("#req-surat"),g=m&&m.files&&m.files[0]?m.files[0]:null,F=await _(f,g);alert(`Request berhasil diajukan! ID Request: ${F.requestId}`),s.reset(),i.modalFormRequest.classList.add("hidden"),r.refetchEvents()}catch(m){alert(`Error: ${m.message}`)}};let S=!1;async function L(){if(S)return;S=!0;const e=M(),t={calendarEl:document.getElementById("calendar"),assetFilter:document.getElementById("calendar-asset-filter"),driverFilter:document.getElementById("calendar-driver-filter"),tabGedung:document.getElementById("calendar-tab-gedung"),tabKendaraan:document.getElementById("calendar-tab-kendaraan"),modal:document.getElementById("modal-detail-event"),modalTitle:document.getElementById("modal-title"),modalBody:document.getElementById("modal-body"),btnSearchBooking:document.getElementById("btn-search-booking"),btnFormRequest:document.getElementById("btn-form"),modalFormRequest:document.getElementById("modal-form-request"),formRequest:document.getElementById("form-request")};if(!t.calendarEl)return;const i=O(e,t);H(t);const r=a=>{e.viewType=a,t.tabGedung?.classList.toggle("active",a==="gedung"),t.tabKendaraan?.classList.toggle("active",a==="kendaraan"),$(e,t),x(e,t),B(e,t),i.refetchEvents()};t.tabGedung?.addEventListener("click",()=>r("gedung")),t.tabKendaraan?.addEventListener("click",()=>r("kendaraan")),t.assetFilter?.addEventListener("change",a=>{e.selectedAsset=a.target.value||"all",i.refetchEvents()}),t.driverFilter?.addEventListener("change",a=>{e.selectedDriver=a.target.value||"all",i.refetchEvents()}),t.btnFormRequest&&t.btnFormRequest.addEventListener("click",()=>{B(e,t),t.modalFormRequest.classList.remove("hidden")}),t.formRequest&&t.formRequest.addEventListener("submit",a=>{Q(a,e,t,i)}),t.modalFormRequest?.querySelector(".modal-close-btn")?.addEventListener("click",()=>t.modalFormRequest.classList.add("hidden")),t.modalFormRequest?.querySelector(".modal-reset-btn")?.addEventListener("click",a=>{a.stopPropagation(),t.formRequest&&t.formRequest.reset()}),t.modalFormRequest?.addEventListener("click",a=>{a.target===t.modalFormRequest&&t.modalFormRequest.classList.add("hidden")}),t.btnSearchBooking&&t.btnSearchBooking.addEventListener("click",async()=>{const a=prompt("Masukkan Booking ID atau Request ID");if(a)try{const l=a.trim();let d;if(/^\d{6}-[A-Z0-9]{5}$/i.test(l))d=await I(l);else if(/^[A-Z0-9]{5}$/i.test(l))d=await E(l);else try{d=await I(l)}catch{d=await E(l)}J(d,e,t)}catch(l){alert(l.message||"Data tidak ditemukan")}});try{const a=await k();e.assets=a.assets,e.drivers=a.drivers,e.bookings=a.bookings,$(e,t),x(e,t),i.refetchEvents()}catch(a){console.error("Gagal memuat data",a),A(t.calendarEl?.parentElement,"Tidak dapat memuat jadwal. Coba beberapa saat lagi.")}i.render(),r("gedung")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L):L();
